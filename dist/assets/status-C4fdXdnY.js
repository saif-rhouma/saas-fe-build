import{dl as dn,r as x,C as M,dq as V,o as Y,S as l,s as K,v as q,dn as X,j as t,I as ln,B as w,Q as un,A as mn,T as B,d0 as G,Y as xn,e4 as R,c_ as gn,dp as fn,dQ as yn,aa as pn,dm as hn,H as bn}from"./index-88qAwG8P.js";import{u as vn}from"./useMutation-Bjm4Nnvr.js";import{u as Cn,a as jn,b as _,c as W,p as Sn,r as In,g as wn,D as On,M as An,S as H,h as Dn,v as Tn,K as $n,T as kn,d as En,e as Q}from"./sortable.esm-Bmkqh5J5.js";import{k as o,u as F,K as Nn,a as Rn,c as _n,b as Fn}from"./kanban-drag-overlay-D1n2q6rM.js";import{u as Ln,m as J}from"./index-CUUWJbjL.js";import{E as Bn}from"./empty-content-vgDCQT8r.js";import{i as Mn}from"./image-CkDsegDa.js";import{L as Kn}from"./ListItem-Bt-kWpW8.js";import{A as qn}from"./AvatarGroup-CWqMds2i.js";import{F as Gn}from"./FormControlLabel-ts_MkIWE.js";import"./utils-km2FGkQ4.js";import"./Skeleton-DnER-xxr.js";import"./InputBase-DD8qHu7J.js";import"./formControlState-Dq1zat_P.js";import"./utils-DoM3o7-Q.js";const L=!0,N=`${M.site.serverUrl}/api/plans-status`,Wn={revalidateIfStale:L,revalidateOnFocus:L,revalidateOnReconnect:L};function Hn(){const{data:e,isLoading:n,error:c,isValidating:b}=Ln(N,dn,Wn);return x.useMemo(()=>{const y=(e==null?void 0:e.board.tasks)??{},p=(e==null?void 0:e.board.columns)??[];return{board:{tasks:y,columns:p,colors:{Pending:"info","Processing A":"warning","Processing B":"error",Ready:"success"}},boardLoading:n,boardError:c,boardValidating:b,boardEmpty:!n&&!p.length}},[e==null?void 0:e.board.columns,e==null?void 0:e.board.tasks,c,n,b])}async function Qn(e){J(N,n=>{const{board:c}=n;return{...n,board:{...c,columns:e}}},!1);{const n={updateColumns:e};await V.post(N,n,{params:{endpoint:"move-column"}})}}async function z(e){J(N,n=>{const{board:c}=n;return{...n,board:{...c,tasks:e}}},!1)}const zn=Y(Kn)(()=>({"@keyframes fadeIn":{"0%":{opacity:0},"100%":{opacity:1}},transform:"translate3d(var(--translate-x, 0), var(--translate-y, 0), 0) scaleX(var(--scale-x, 1)) scaleY(var(--scale-y, 1))",transformOrigin:"0 0",touchAction:"manipulation",[`&.${o.state.fadeIn}`]:{animation:"fadeIn 500ms ease"},[`&.${o.state.dragOverlay}`]:{zIndex:999}})),Un=Y(l)(({theme:e})=>({width:"100%",cursor:"grab",outline:"none",overflow:"hidden",position:"relative",transformOrigin:"50% 50%",touchAction:"manipulation",boxShadow:e.customShadows.z1,borderRadius:"var(--item-radius)",WebkitTapHighlightColor:"transparent",backgroundColor:e.vars.palette.common.white,transition:e.transitions.create(["box-shadow"]),[K.dark]:{backgroundColor:e.vars.palette.grey[900]},[`&.${o.state.disabled}`]:{},[`&.${o.state.sorting}`]:{},[`&.${o.state.dragOverlay}`]:{backdropFilter:"blur(6px)",boxShadow:e.customShadows.z20,backgroundColor:q(e.vars.palette.common.whiteChannel,.48),[K.dark]:{backgroundColor:q(e.vars.palette.grey["900Channel"],.48)}},[`&.${o.state.dragging}`]:{opacity:.2,filter:"grayscale(1)"}})),Vn=x.forwardRef(({task:e,stateProps:n,sx:c,...b},v)=>{var C,O,A,T;const{t:y}=X("plans-status");x.useEffect(()=>{if(n!=null&&n.dragOverlay)return document.body.style.cursor="grabbing",()=>{document.body.style.cursor=""}},[n==null?void 0:n.dragOverlay]);const p=o.itemWrap.concat((n==null?void 0:n.fadeIn)&&` ${o.state.fadeIn}`||(n==null?void 0:n.dragOverlay)&&` ${o.state.dragOverlay}`||""),h=o.item.concat((n==null?void 0:n.dragging)&&` ${o.state.dragging}`||(n==null?void 0:n.disabled)&&` ${o.state.disabled}`||(n==null?void 0:n.sorting)&&` ${o.state.sorting}`||(n==null?void 0:n.dragOverlay)&&` ${o.state.dragOverlay}`||""),g=t.jsx(ln,{icon:e.status==="Delivered"?"solar:double-alt-arrow-up-bold-duotone":"solar:double-alt-arrow-right-bold-duotone",sx:{top:4,right:4,position:"absolute",...e.status==="ProcessingA"&&{color:"warning.main"},...e.status==="Ready"&&{color:"success.main"},...e.status==="Pending"&&{color:"info.main"},...e.status==="ProcessingB"&&{color:"error.main"}}}),j=t.jsxs(l,{direction:"row",alignItems:"center",children:[t.jsx(l,{flexGrow:1,direction:"row",alignItems:"center",sx:{typography:"caption",color:"text.disabled"},children:t.jsxs(w,{component:"span",sx:{mr:1},children:[y("card.products"),":"]})}),t.jsx(qn,{sx:{[`& .${un.avatar}`]:{width:24,height:24}},children:t.jsx(mn,{alt:(C=e==null?void 0:e.product)==null?void 0:C.name,src:`${M.site.serverFileHost}${(O=e==null?void 0:e.product)==null?void 0:O.image}`},(A=e==null?void 0:e.product)==null?void 0:A.id)})]});return t.jsx(zn,{ref:v,disablePadding:!0,className:p,sx:{...!!(n!=null&&n.transition)&&{transition:n.transition},...!!(n!=null&&n.transform)&&{"--translate-x":`${Math.round(n.transform.x)}px`,"--translate-y":`${Math.round(n.transform.y)}px`,"--scale-x":`${n.transform.scaleX}`,"--scale-y":`${n.transform.scaleY}`}},children:t.jsx(Un,{className:h,"data-cypress":"draggable-item",sx:c,tabIndex:0,...n==null?void 0:n.listeners,...b,children:t.jsxs(l,{spacing:1,sx:{px:2,py:2.5,position:"relative"},children:[g,t.jsxs(l,{direction:"row",justifyContent:"space-between",children:[t.jsx(B,{variant:"subtitle2",children:(T=e==null?void 0:e.product)==null?void 0:T.name}),t.jsx(B,{variant:"subtitle2",children:e==null?void 0:e.ref})]}),t.jsxs(l,{direction:"row",justifyContent:"space-between",sx:{typography:"body2"},children:[t.jsx(w,{sx:{color:"text.secondary"},children:y("card.planDate")}),t.jsx(w,{sx:{color:"text.secondary"},children:G(e==null?void 0:e.planDate)})]}),t.jsxs(l,{direction:"row",justifyContent:"space-between",sx:{typography:"body2"},children:[t.jsx(w,{sx:{color:"text.secondary"},children:y("card.quantity")}),t.jsx(w,{sx:{color:"text.secondary"},children:e.quantity?e.quantity:"-"})]}),t.jsxs(l,{direction:"row",justifyContent:"space-between",sx:{typography:"body2"},children:[t.jsx(w,{sx:{color:"text.secondary"},children:y("card.lastUpdate")}),t.jsx(w,{sx:{color:"text.secondary"},children:G(e==null?void 0:e.updateTime)})]}),j]})})})}),Yn=x.memo(Vn);function Xn({task:e,disabled:n,columnId:c,sx:b}){const v=xn(),{setNodeRef:y,listeners:p,isDragging:h,isSorting:g,transform:j,transition:C}=Cn({id:e==null?void 0:e.id}),O=Jn(),A=h&&!O;return t.jsx(Yn,{ref:n?void 0:y,task:e,onClick:v.onTrue,stateProps:{transform:j,listeners:p,transition:C,sorting:g,dragging:h,fadeIn:A},sx:{...v.value&&{[`& .${Mn.root}`]:{opacity:.8}},...b}})}function Jn(){const[e,n]=x.useState(!1);return x.useEffect(()=>{const c=setTimeout(()=>n(!0),500);return()=>clearTimeout(c)},[]),e}const U={"--item-gap":"16px","--item-radius":"12px","--column-gap":"24px","--column-width":"calc(95% /4)","--column-radius":"16px","--column-padding":"20px 16px 16px 16px"};function Zn(){const{t:e}=X("plans-status"),{board:n,boardLoading:c,boardEmpty:b}=Hn(),[v,y]=x.useState(!0),p=x.useRef(!1),h=x.useRef(null),[g,j]=x.useState(null),C=n.columns.map(s=>s.id),O=g?C.includes(g):!1,A=jn(_(En,{activationConstraint:{distance:5}}),_(kn,{activationConstraint:{distance:5}}),_($n,{coordinateGetter:_n})),T=x.useCallback(s=>{var d;if(g&&g in n.tasks)return W({...s,droppableContainers:s.droppableContainers.filter(f=>f.id in n.tasks)});const a=Sn(s),r=a.length>0?a:In(s);let i=wn(r,"id");if(i!=null){if(i in n.tasks){const f=n.tasks[i].map(u=>u.id);f.length>0&&(i=(d=W({...s,droppableContainers:s.droppableContainers.filter(u=>u.id!==i&&f.includes(u.id))})[0])==null?void 0:d.id)}return h.current=i,[{id:i}]}return p.current&&(h.current=g),h.current?[{id:h.current}]:[]},[g,n==null?void 0:n.tasks]),$=s=>s in n.tasks?s:Object.keys(n.tasks).find(a=>n.tasks[a].map(r=>r.id).includes(s));x.useEffect(()=>{requestAnimationFrame(()=>{p.current=!1})},[]);const Z=({active:s})=>{j(s.id)},P=({active:s,over:a})=>{const r=a==null?void 0:a.id;if(r==null||s.id in n.tasks)return;const i=$(r),d=$(s.id);if(!(!i||!d)&&d!==i){const f=n.tasks[d].map(m=>m.id),u=n.tasks[i].map(m=>m.id),D=u.indexOf(r),S=f.indexOf(s.id);let I;if(r in n.tasks)I=u.length+1;else{const cn=a&&s.rect.current.translated&&s.rect.current.translated.top>a.rect.top+a.rect.height?1:0;I=D>=0?D+cn:u.length+1}p.current=!0;const E={...n.tasks,[d]:n.tasks[d].filter(m=>m.id!==s.id),[i]:[...n.tasks[i].slice(0,I),n.tasks[d][S],...n.tasks[i].slice(I,n.tasks[i].length)]};z(E)}},nn=()=>{n.columns.forEach(s=>{for(let a=0;a<n.tasks[s.id].length;a++)s.name==="Pending"&&(n.tasks[s.id][a].status="Pending"),s.name==="Processing A"&&(n.tasks[s.id][a].status="ProcessingA"),s.name==="Processing B"&&(n.tasks[s.id][a].status="ProcessingB"),s.name==="Ready"&&(n.tasks[s.id][a].status="Ready")})},en=async s=>{const a=[];n.columns.forEach(i=>{a.push(...n.tasks[i.id])});const r=a.find(i=>i.id===s.id);if(r){const i={status:r.status};await on({id:r.id,payload:i})}},sn=({active:s,over:a})=>{let r;if(s.id in n.tasks&&(a!=null&&a.id)){const u=C.indexOf(s.id),D=C.indexOf(a.id),S=Q(n.columns,u,D);Qn(S)}const i=$(s.id);if(!i){j(null);return}const d=a==null?void 0:a.id;if(d==null){j(null);return}const f=$(d);if(f){const u=n.tasks[i].map(m=>m.id),D=n.tasks[f].map(m=>m.id),S=u.indexOf(s.id),I=D.indexOf(d),E=n.tasks[i][S];if(S!==I){const m={...n.tasks,[f]:Q(n.tasks[f],S,I)};z(m)}r={id:E.id,payload:{status:E.status}}}nn(),en(r),j(null)},tn=t.jsx(l,{direction:"row",alignItems:"flex-start",sx:{gap:"var(--column-gap)"},children:t.jsx(Fn,{})}),an=t.jsx(Bn,{filled:!0,sx:{py:10,maxHeight:{md:480}}}),rn=t.jsxs(On,{id:"dnd-kanban",sensors:A,collisionDetection:T,measuring:{droppable:{strategy:An.Always}},onDragStart:F(R.PLAN_STATUS_SCREEN_DRAG_AND_DROP)&&Z,onDragOver:F(R.PLAN_STATUS_SCREEN_DRAG_AND_DROP)&&P,onDragEnd:F(R.PLAN_STATUS_SCREEN_DRAG_AND_DROP)&&sn,children:[t.jsx(l,{sx:{flex:"1 1 auto",overflowX:"auto"},children:t.jsx(l,{sx:{pb:3,display:"unset",...v&&{minHeight:0,display:"flex",flex:"1 1 auto"}},children:t.jsx(l,{direction:"row",sx:{gap:"var(--column-gap)",...v&&{minHeight:0,flex:"1 1 auto",[`& .${o.columnList}`]:{...gn,flex:"1 1 auto"}}},children:t.jsx(H,{items:[C],strategy:Dn,children:n==null?void 0:n.columns.map(s=>t.jsx(Nn,{column:s,tasks:n.tasks[s.id],colors:n.colors,children:t.jsx(H,{items:n.tasks[s.id],strategy:Tn,children:n.tasks[s.id].map(a=>t.jsx(Xn,{task:a,columnId:s.id,disabled:O},a.id))})},s.id))})})})}),t.jsx(Rn,{columns:n==null?void 0:n.columns,tasks:n==null?void 0:n.tasks,activeId:g,sx:U})]}),k=fn(),{mutate:on}=vn({mutationFn:({id:s,payload:a})=>V.patch(hn.planStatus.edit+s,a),onSuccess:async({data:s})=>{const{id:a}=s;await k.invalidateQueries({queryKey:["plans"]}),await k.invalidateQueries({queryKey:["plans","analytics"]}),await k.invalidateQueries({queryKey:["plans-status"]}),await k.invalidateQueries({queryKey:["plan",a]})},onSettled:async()=>{},onError:s=>{console.log(s)}});return t.jsxs(yn,{maxWidth:!1,sx:{...U,pb:0,pl:{sm:3},pr:{sm:0},flex:"1 1 0",display:"flex",overflow:"hidden",flexDirection:"column"},children:[t.jsxs(l,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{pr:{sm:3},mb:{xs:3,md:5}},children:[t.jsx(B,{variant:"h4",children:e("title")}),t.jsx(Gn,{label:e("columnFixed"),labelPlacement:"start",control:t.jsx(pn,{checked:v,onChange:s=>{y(s.target.checked)},inputProps:{id:"column-fixed-switch"}})})]}),c?tn:t.jsx(t.Fragment,{children:b?an:rn})]})}const Pn={title:`Plan Status | Dashboard - ${M.site.name}`};function fe(){return t.jsxs(t.Fragment,{children:[t.jsx(bn,{children:t.jsxs("title",{children:[" ",Pn.title]})}),t.jsx(Zn,{})]})}export{fe as default};

import{dJ as X,r as h,C as R,dM as H,j as a,S as b,aH as Y,dL as Z,eb as ss,T as ts,bL as es,dK as ns,bM as as,H as is}from"./index-DLJImauo.js";import{u as rs,a as D,c as T,p as os,r as ds,g as ls,D as cs,M as us,S as K,h as ms,v as ps,K as fs,T as xs,b as ks,d as F}from"./sortable.esm-DxmejKuL.js";import{u as hs,m as N}from"./index-BoF40ko4.js";import{E as gs}from"./empty-content-C2NUDuUr.js";import{u as ys}from"./useMutation-7HTcUz2p.js";import{k as bs,K as Cs,a as Is,c as Ss,b as vs}from"./utils-DAVC7BQC.js";import{K as js}from"./kanban-task-item-BnMY-8bv.js";import{F as Os}from"./FormControlLabel-C_QV2Cmj.js";import"./utils-km2FGkQ4.js";import"./ListItem-BofKFpgJ.js";import"./AvatarGroup-D-HfCwBX.js";import"./InputBase-DlzL5OFi.js";import"./formControlState-Dq1zat_P.js";import"./utils-DoM3o7-Q.js";import"./Skeleton-BFlFQZOr.js";import"./image-BZDZbX9M.js";const w=!0,j=`${R.site.serverUrl}/api/orders-status`,Ds={revalidateIfStale:w,revalidateOnFocus:w,revalidateOnReconnect:w};function ws(){const{data:s,isLoading:d,error:u,isValidating:m}=hs(j,X,Ds);return h.useMemo(()=>{const y=(s==null?void 0:s.board.tasks)??{},p=(s==null?void 0:s.board.columns)??[];return{board:{tasks:y,columns:p},boardLoading:d,boardError:u,boardValidating:m,boardEmpty:!d&&!p.length}},[s==null?void 0:s.board.columns,s==null?void 0:s.board.tasks,u,d,m])}async function Es(s){N(j,d=>{const{board:u}=d;return{...d,board:{...u,columns:s}}},!1);{const d={updateColumns:s};await H.post(j,d,{params:{endpoint:"move-column"}})}}async function L(s){N(j,d=>{const{board:u}=d;return{...d,board:{...u,tasks:s}}},!1)}const M={"--item-gap":"16px","--item-radius":"12px","--column-gap":"24px","--column-width":"calc(95% /3)","--column-radius":"16px","--column-padding":"20px 16px 16px 16px"};function Ts(){const{board:s,boardLoading:d,boardEmpty:u}=ws(),[m,E]=h.useState(!0),y=h.useRef(!1),p=h.useRef(null),[f,C]=h.useState(null),I=s.columns.map(t=>t.id),P=f?I.includes(f):!1,V=rs(D(ks,{activationConstraint:{distance:5}}),D(xs,{activationConstraint:{distance:5}}),D(fs,{coordinateGetter:Ss})),q=h.useCallback(t=>{var i;if(f&&f in s.tasks)return T({...t,droppableContainers:t.droppableContainers.filter(r=>r.id in s.tasks)});const e=os(t),o=e.length>0?e:ds(t);let n=ls(o,"id");if(n!=null){if(n in s.tasks){const r=s.tasks[n].map(l=>l.id);r.length>0&&(n=(i=T({...t,droppableContainers:t.droppableContainers.filter(l=>l.id!==n&&r.includes(l.id))})[0])==null?void 0:i.id)}return p.current=n,[{id:n}]}return y.current&&(p.current=f),p.current?[{id:p.current}]:[]},[f,s==null?void 0:s.tasks]),S=t=>t in s.tasks?t:Object.keys(s.tasks).find(e=>s.tasks[e].map(o=>o.id).includes(t));h.useEffect(()=>{requestAnimationFrame(()=>{y.current=!1})},[]);const A=({active:t})=>{C(t.id)},B=({active:t,over:e})=>{const o=e==null?void 0:e.id;if(o==null||t.id in s.tasks)return;const n=S(o),i=S(t.id);if(!(!n||!i)&&i!==n){const r=s.tasks[i].map(c=>c.id),l=s.tasks[n].map(c=>c.id),g=l.indexOf(o),x=r.indexOf(t.id);let k;if(o in s.tasks)k=l.length+1;else{const J=e&&t.rect.current.translated&&t.rect.current.translated.top>e.rect.top+e.rect.height?1:0;k=g>=0?g+J:l.length+1}y.current=!0;const v={...s.tasks,[i]:s.tasks[i].filter(c=>c.id!==t.id),[n]:[...s.tasks[n].slice(0,k),s.tasks[i][x],...s.tasks[n].slice(k,s.tasks[n].length)]};L(v)}},Q=()=>{s.columns.forEach(t=>{for(let e=0;e<s.tasks[t.id].length;e++)t.name==="In Process"&&(s.tasks[t.id][e].status="InProcess"),t.name==="Ready to Deliver"&&(s.tasks[t.id][e].status="Ready"),t.name==="Delivered"&&(s.tasks[t.id][e].status="Delivered")})},z=async t=>{const e=[];s.columns.forEach(n=>{e.push(...s.tasks[n.id])});const o=e.find(n=>n.id===t.id);if(o){const n={status:o.status};o.status==="Delivered"?(n.deliveryDate=as(),s.columns.forEach(i=>{for(let r=0;r<s.tasks[i.id].length;r++)s.tasks[i.id][r].id===o.id&&(s.tasks[i.id][r].deliveryDate=n.deliveryDate)})):(n.deliveryDate=null,o.deliveryDate&&s.columns.forEach(i=>{for(let r=0;r<s.tasks[i.id].length;r++)s.tasks[i.id][r].id===o.id&&(s.tasks[i.id][r].deliveryDate=null)})),await _({id:o.id,payload:n})}},G=({active:t,over:e})=>{let o;if(t.id in s.tasks&&(e!=null&&e.id)){const l=I.indexOf(t.id),g=I.indexOf(e.id),x=F(s.columns,l,g);Es(x)}const n=S(t.id);if(!n){C(null);return}const i=e==null?void 0:e.id;if(i==null){C(null);return}const r=S(i);if(r){const l=s.tasks[n].map(c=>c.id),g=s.tasks[r].map(c=>c.id),x=l.indexOf(t.id),k=g.indexOf(i),v=s.tasks[n][x];if(x!==k){const c={...s.tasks,[r]:F(s.tasks[r],x,k)};L(c)}o={id:v.id,payload:{status:v.status}}}Q(),z(o),C(null)},W=a.jsx(b,{direction:"row",alignItems:"flex-start",sx:{gap:"var(--column-gap)"},children:a.jsx(vs,{})}),$=a.jsx(gs,{filled:!0,sx:{py:10,maxHeight:{md:480}}}),U=a.jsxs(cs,{id:"dnd-kanban",sensors:V,collisionDetection:q,measuring:{droppable:{strategy:us.Always}},onDragStart:A,onDragOver:B,onDragEnd:G,children:[a.jsx(b,{sx:{flex:"1 1 auto",overflowX:"auto"},children:a.jsx(b,{sx:{pb:3,display:"unset",...m&&{minHeight:0,display:"flex",flex:"1 1 auto"}},children:a.jsx(b,{direction:"row",sx:{gap:"var(--column-gap)",...m&&{minHeight:0,flex:"1 1 auto",[`& .${bs.columnList}`]:{...Y,flex:"1 1 auto"}}},children:a.jsx(K,{items:[I],strategy:ms,children:s==null?void 0:s.columns.map(t=>a.jsx(Cs,{column:t,tasks:s.tasks[t.id],children:a.jsx(K,{items:s.tasks[t.id],strategy:ps,children:s.tasks[t.id].map(e=>a.jsx(js,{task:e,columnId:t.id,disabled:P},e.id))})},t.id))})})})}),a.jsx(Is,{columns:s==null?void 0:s.columns,tasks:s==null?void 0:s.tasks,activeId:f,sx:M})]}),O=Z(),{mutate:_}=ys({mutationFn:({id:t,payload:e})=>H.patch(ns.orderStatus.edit+t,e),onSuccess:async()=>{await O.invalidateQueries({queryKey:["orders"]}),await O.invalidateQueries({queryKey:["orders","analytics"]}),await O.invalidateQueries({queryKey:["orders-status"]})},onSettled:async()=>{},onError:t=>{console.log(t)}});return a.jsxs(ss,{maxWidth:!1,sx:{...M,pb:0,pl:{sm:3},pr:{sm:0},flex:"1 1 0",display:"flex",overflow:"hidden",flexDirection:"column"},children:[a.jsxs(b,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{pr:{sm:3},mb:{xs:3,md:5}},children:[a.jsx(ts,{variant:"h4",children:"Orders Status"}),a.jsx(Os,{label:"Column fixed",labelPlacement:"start",control:a.jsx(es,{checked:m,onChange:t=>{E(t.target.checked)},inputProps:{id:"column-fixed-switch"}})})]}),d?W:a.jsx(a.Fragment,{children:u?$:U})]})}const Ks={title:`Order Status | Dashboard - ${R.site.name}`};function Us(){return a.jsxs(a.Fragment,{children:[a.jsx(is,{children:a.jsxs("title",{children:[" ",Ks.title]})}),a.jsx(Ts,{})]})}export{Us as default};

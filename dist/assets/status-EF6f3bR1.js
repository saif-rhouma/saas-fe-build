import{dl as on,r as g,C as M,dp as Q,aw as U,S as c,s as B,v as K,j as s,I as dn,B as I,aL as ln,A as cn,T as F,d0 as G,i as un,e3 as N,c_ as mn,dn as xn,dP as gn,aV as fn,dm as yn,H as hn}from"./index-KK-mXlr9.js";import{u as pn}from"./useMutation-BLbhE-7U.js";import{u as bn,a as Cn,b as R,c as q,p as vn,r as Sn,g as jn,D as In,M as wn,S as W,h as Dn,v as On,K as An,T as Tn,d as $n,e as H}from"./sortable.esm-DAdyvOGi.js";import{k as o,u as _,K as kn,a as En,c as Nn,b as Rn}from"./kanban-drag-overlay-DEcviF53.js";import{u as _n,m as X}from"./index-BQUlAtM1.js";import{E as Ln}from"./empty-content-wJX0dBLP.js";import{i as Fn}from"./image-DBvfg_3r.js";import{L as Mn}from"./ListItem-B93uRZH_.js";import{A as Bn}from"./AvatarGroup-YLmu1og-.js";import{F as Kn}from"./FormControlLabel-CMZe9nOT.js";import"./utils-km2FGkQ4.js";import"./Skeleton-Du8ap9MK.js";import"./InputBase-DeC6BCyF.js";import"./formControlState-Dq1zat_P.js";import"./utils-DoM3o7-Q.js";const L=!0,E=`${M.site.serverUrl}/api/plans-status`,Gn={revalidateIfStale:L,revalidateOnFocus:L,revalidateOnReconnect:L};function qn(){const{data:n,isLoading:e,error:d,isValidating:f}=_n(E,on,Gn);return g.useMemo(()=>{const p=(n==null?void 0:n.board.tasks)??{},y=(n==null?void 0:n.board.columns)??[];return{board:{tasks:p,columns:y},boardLoading:e,boardError:d,boardValidating:f,boardEmpty:!e&&!y.length}},[n==null?void 0:n.board.columns,n==null?void 0:n.board.tasks,d,e,f])}async function Wn(n){X(E,e=>{const{board:d}=e;return{...e,board:{...d,columns:n}}},!1);{const e={updateColumns:n};await Q.post(E,e,{params:{endpoint:"move-column"}})}}async function V(n){X(E,e=>{const{board:d}=e;return{...e,board:{...d,tasks:n}}},!1)}const Hn=U(Mn)(()=>({"@keyframes fadeIn":{"0%":{opacity:0},"100%":{opacity:1}},transform:"translate3d(var(--translate-x, 0), var(--translate-y, 0), 0) scaleX(var(--scale-x, 1)) scaleY(var(--scale-y, 1))",transformOrigin:"0 0",touchAction:"manipulation",[`&.${o.state.fadeIn}`]:{animation:"fadeIn 500ms ease"},[`&.${o.state.dragOverlay}`]:{zIndex:999}})),Vn=U(c)(({theme:n})=>({width:"100%",cursor:"grab",outline:"none",overflow:"hidden",position:"relative",transformOrigin:"50% 50%",touchAction:"manipulation",boxShadow:n.customShadows.z1,borderRadius:"var(--item-radius)",WebkitTapHighlightColor:"transparent",backgroundColor:n.vars.palette.common.white,transition:n.transitions.create(["box-shadow"]),[B.dark]:{backgroundColor:n.vars.palette.grey[900]},[`&.${o.state.disabled}`]:{},[`&.${o.state.sorting}`]:{},[`&.${o.state.dragOverlay}`]:{backdropFilter:"blur(6px)",boxShadow:n.customShadows.z20,backgroundColor:K(n.vars.palette.common.whiteChannel,.48),[B.dark]:{backgroundColor:K(n.vars.palette.grey["900Channel"],.48)}},[`&.${o.state.dragging}`]:{opacity:.2,filter:"grayscale(1)"}})),zn=g.forwardRef(({task:n,stateProps:e,sx:d,...f},v)=>{var b,w,D,O;g.useEffect(()=>{if(e!=null&&e.dragOverlay)return document.body.style.cursor="grabbing",()=>{document.body.style.cursor=""}},[e==null?void 0:e.dragOverlay]);const p=o.itemWrap.concat((e==null?void 0:e.fadeIn)&&` ${o.state.fadeIn}`||(e==null?void 0:e.dragOverlay)&&` ${o.state.dragOverlay}`||""),y=o.item.concat((e==null?void 0:e.dragging)&&` ${o.state.dragging}`||(e==null?void 0:e.disabled)&&` ${o.state.disabled}`||(e==null?void 0:e.sorting)&&` ${o.state.sorting}`||(e==null?void 0:e.dragOverlay)&&` ${o.state.dragOverlay}`||""),u=s.jsx(dn,{icon:n.status==="Delivered"?"solar:double-alt-arrow-up-bold-duotone":"solar:double-alt-arrow-right-bold-duotone",sx:{top:4,right:4,position:"absolute",...n.status==="ProcessingA"&&{color:"warning.main"},...n.status==="Ready"&&{color:"success.main"},...n.status==="Pending"&&{color:"info.main"},...n.status==="ProcessingB"&&{color:"error.main"}}}),C=s.jsxs(c,{direction:"row",alignItems:"center",children:[s.jsx(c,{flexGrow:1,direction:"row",alignItems:"center",sx:{typography:"caption",color:"text.disabled"},children:s.jsx(I,{component:"span",sx:{mr:1},children:"Product:"})}),s.jsx(Bn,{sx:{[`& .${ln.avatar}`]:{width:24,height:24}},children:s.jsx(cn,{alt:(b=n==null?void 0:n.product)==null?void 0:b.name,src:`${M.site.serverFileHost}${(w=n==null?void 0:n.product)==null?void 0:w.image}`},(D=n==null?void 0:n.product)==null?void 0:D.id)})]});return s.jsx(Hn,{ref:v,disablePadding:!0,className:p,sx:{...!!(e!=null&&e.transition)&&{transition:e.transition},...!!(e!=null&&e.transform)&&{"--translate-x":`${Math.round(e.transform.x)}px`,"--translate-y":`${Math.round(e.transform.y)}px`,"--scale-x":`${e.transform.scaleX}`,"--scale-y":`${e.transform.scaleY}`}},children:s.jsx(Vn,{className:y,"data-cypress":"draggable-item",sx:d,tabIndex:0,...e==null?void 0:e.listeners,...f,children:s.jsxs(c,{spacing:1,sx:{px:2,py:2.5,position:"relative"},children:[u,s.jsxs(c,{direction:"row",justifyContent:"space-between",children:[s.jsx(F,{variant:"subtitle2",children:(O=n==null?void 0:n.product)==null?void 0:O.name}),s.jsx(F,{variant:"subtitle2",children:n==null?void 0:n.ref})]}),s.jsxs(c,{direction:"row",justifyContent:"space-between",sx:{typography:"body2"},children:[s.jsx(I,{sx:{color:"text.secondary"},children:"Plan Date:"}),s.jsx(I,{sx:{color:"text.secondary"},children:G(n==null?void 0:n.planDate)})]}),s.jsxs(c,{direction:"row",justifyContent:"space-between",sx:{typography:"body2"},children:[s.jsx(I,{sx:{color:"text.secondary"},children:"Quantity:"}),s.jsx(I,{sx:{color:"text.secondary"},children:n.quantity?n.quantity:"-"})]}),s.jsxs(c,{direction:"row",justifyContent:"space-between",sx:{typography:"body2"},children:[s.jsx(I,{sx:{color:"text.secondary"},children:"Last Updated Date:"}),s.jsx(I,{sx:{color:"text.secondary"},children:G(n==null?void 0:n.updateTime)})]}),C]})})})}),Qn=g.memo(zn);function Un({task:n,disabled:e,columnId:d,sx:f}){const v=un(),{setNodeRef:p,listeners:y,isDragging:u,isSorting:C,transform:b,transition:w}=bn({id:n==null?void 0:n.id}),D=Xn(),O=u&&!D;return s.jsx(Qn,{ref:e?void 0:p,task:n,onClick:v.onTrue,stateProps:{transform:b,listeners:y,transition:w,sorting:C,dragging:u,fadeIn:O},sx:{...v.value&&{[`& .${Fn.root}`]:{opacity:.8}},...f}})}function Xn(){const[n,e]=g.useState(!1);return g.useEffect(()=>{const d=setTimeout(()=>e(!0),500);return()=>clearTimeout(d)},[]),n}const z={"--item-gap":"16px","--item-radius":"12px","--column-gap":"24px","--column-width":"calc(95% /4)","--column-radius":"16px","--column-padding":"20px 16px 16px 16px"};function Yn(){const{board:n,boardLoading:e,boardEmpty:d}=qn(),[f,v]=g.useState(!0),p=g.useRef(!1),y=g.useRef(null),[u,C]=g.useState(null),b=n.columns.map(t=>t.id),w=u?b.includes(u):!1,D=Cn(R($n,{activationConstraint:{distance:5}}),R(Tn,{activationConstraint:{distance:5}}),R(An,{coordinateGetter:Nn})),O=g.useCallback(t=>{var l;if(u&&u in n.tasks)return q({...t,droppableContainers:t.droppableContainers.filter(h=>h.id in n.tasks)});const a=vn(t),r=a.length>0?a:Sn(t);let i=jn(r,"id");if(i!=null){if(i in n.tasks){const h=n.tasks[i].map(m=>m.id);h.length>0&&(i=(l=q({...t,droppableContainers:t.droppableContainers.filter(m=>m.id!==i&&h.includes(m.id))})[0])==null?void 0:l.id)}return y.current=i,[{id:i}]}return p.current&&(y.current=u),y.current?[{id:y.current}]:[]},[u,n==null?void 0:n.tasks]),T=t=>t in n.tasks?t:Object.keys(n.tasks).find(a=>n.tasks[a].map(r=>r.id).includes(t));g.useEffect(()=>{requestAnimationFrame(()=>{p.current=!1})},[]);const Y=({active:t})=>{C(t.id)},J=({active:t,over:a})=>{const r=a==null?void 0:a.id;if(r==null||t.id in n.tasks)return;const i=T(r),l=T(t.id);if(!(!i||!l)&&l!==i){const h=n.tasks[l].map(x=>x.id),m=n.tasks[i].map(x=>x.id),A=m.indexOf(r),S=h.indexOf(t.id);let j;if(r in n.tasks)j=m.length+1;else{const rn=a&&t.rect.current.translated&&t.rect.current.translated.top>a.rect.top+a.rect.height?1:0;j=A>=0?A+rn:m.length+1}p.current=!0;const k={...n.tasks,[l]:n.tasks[l].filter(x=>x.id!==t.id),[i]:[...n.tasks[i].slice(0,j),n.tasks[l][S],...n.tasks[i].slice(j,n.tasks[i].length)]};V(k)}},Z=()=>{n.columns.forEach(t=>{for(let a=0;a<n.tasks[t.id].length;a++)t.name==="Pending"&&(n.tasks[t.id][a].status="Pending"),t.name==="Processing A"&&(n.tasks[t.id][a].status="ProcessingA"),t.name==="Processing B"&&(n.tasks[t.id][a].status="ProcessingB"),t.name==="Ready"&&(n.tasks[t.id][a].status="Ready")})},P=async t=>{const a=[];n.columns.forEach(i=>{a.push(...n.tasks[i.id])});const r=a.find(i=>i.id===t.id);if(r){const i={status:r.status};await an({id:r.id,payload:i})}},nn=({active:t,over:a})=>{let r;if(t.id in n.tasks&&(a!=null&&a.id)){const m=b.indexOf(t.id),A=b.indexOf(a.id),S=H(n.columns,m,A);Wn(S)}const i=T(t.id);if(!i){C(null);return}const l=a==null?void 0:a.id;if(l==null){C(null);return}const h=T(l);if(h){const m=n.tasks[i].map(x=>x.id),A=n.tasks[h].map(x=>x.id),S=m.indexOf(t.id),j=A.indexOf(l),k=n.tasks[i][S];if(S!==j){const x={...n.tasks,[h]:H(n.tasks[h],S,j)};V(x)}r={id:k.id,payload:{status:k.status}}}Z(),P(r),C(null)},en=s.jsx(c,{direction:"row",alignItems:"flex-start",sx:{gap:"var(--column-gap)"},children:s.jsx(Rn,{})}),tn=s.jsx(Ln,{filled:!0,sx:{py:10,maxHeight:{md:480}}}),sn=s.jsxs(In,{id:"dnd-kanban",sensors:D,collisionDetection:O,measuring:{droppable:{strategy:wn.Always}},onDragStart:_(N.PLAN_STATUS_SCREEN_DRAG_AND_DROP)&&Y,onDragOver:_(N.PLAN_STATUS_SCREEN_DRAG_AND_DROP)&&J,onDragEnd:_(N.PLAN_STATUS_SCREEN_DRAG_AND_DROP)&&nn,children:[s.jsx(c,{sx:{flex:"1 1 auto",overflowX:"auto"},children:s.jsx(c,{sx:{pb:3,display:"unset",...f&&{minHeight:0,display:"flex",flex:"1 1 auto"}},children:s.jsx(c,{direction:"row",sx:{gap:"var(--column-gap)",...f&&{minHeight:0,flex:"1 1 auto",[`& .${o.columnList}`]:{...mn,flex:"1 1 auto"}}},children:s.jsx(W,{items:[b],strategy:Dn,children:n==null?void 0:n.columns.map(t=>s.jsx(kn,{column:t,tasks:n.tasks[t.id],children:s.jsx(W,{items:n.tasks[t.id],strategy:On,children:n.tasks[t.id].map(a=>s.jsx(Un,{task:a,columnId:t.id,disabled:w},a.id))})},t.id))})})})}),s.jsx(En,{columns:n==null?void 0:n.columns,tasks:n==null?void 0:n.tasks,activeId:u,sx:z})]}),$=xn(),{mutate:an}=pn({mutationFn:({id:t,payload:a})=>Q.patch(yn.planStatus.edit+t,a),onSuccess:async({data:t})=>{const{id:a}=t;await $.invalidateQueries({queryKey:["plans"]}),await $.invalidateQueries({queryKey:["plans","analytics"]}),await $.invalidateQueries({queryKey:["plans-status"]}),await $.invalidateQueries({queryKey:["plan",a]})},onSettled:async()=>{},onError:t=>{console.log(t)}});return s.jsxs(gn,{maxWidth:!1,sx:{...z,pb:0,pl:{sm:3},pr:{sm:0},flex:"1 1 0",display:"flex",overflow:"hidden",flexDirection:"column"},children:[s.jsxs(c,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{pr:{sm:3},mb:{xs:3,md:5}},children:[s.jsx(F,{variant:"h4",children:"Plans Status"}),s.jsx(Kn,{label:"Column fixed",labelPlacement:"start",control:s.jsx(fn,{checked:f,onChange:t=>{v(t.target.checked)},inputProps:{id:"column-fixed-switch"}})})]}),e?en:s.jsx(s.Fragment,{children:d?tn:sn})]})}const Jn={title:`Plan Status | Dashboard - ${M.site.name}`};function xe(){return s.jsxs(s.Fragment,{children:[s.jsx(hn,{children:s.jsxs("title",{children:[" ",Jn.title]})}),s.jsx(Yn,{})]})}export{xe as default};

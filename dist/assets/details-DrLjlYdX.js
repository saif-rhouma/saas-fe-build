import{j as t,B as a,T as Y,c7 as D,I as u,eh as J,d7 as _,S as l,ef as c,e8 as H,e4 as S,e as E,cY as G,dP as M,h as X,g as Z,r as h,p as q,ea as tt,i as K,dp as w,dm as C,l as V,d0 as L,ei as et,dn as st,eb as it,ej as $,dQ as nt,cV as A,dq as Q,dU as at,H as lt,C as ot}from"./index-CC8ZOXtA.js";import{u as U,E as rt}from"./error-block-ClcTD9po.js";import{u as ct}from"./use-params-BOns0CVy.js";import"./chart-legends-BNfxg7FD.js";import{P as dt,a as pt,O as xt}from"./order-status-dialog-CydM4mpC.js";import{l as mt}from"./index-D4yFGiDZ.js";import{u as N}from"./useMutation-DdAIUrKi.js";import{C as ht}from"./confirm-dialog-MYD50ozi.js";import{C as ut}from"./custom-breadcrumbs-Bl5OnNTu.js";import{b as R}from"./format-number-pdBITjLa.js";import{P as k}from"./permission-access-controller-CWt3Qm2o.js";import{T as jt,t as yt,a as ft,b as gt,c as bt,d as Dt,e as wt}from"./TimelineSeparator-ClxY2UCf.js";import{C as W}from"./CardHeader-D47k68P3.js";import{O as Ct}from"./order-product-table-C564GiNP.js";import{C as Tt}from"./CircularProgress-DBXL2oaw.js";import"./utils-km2FGkQ4.js";import"./bounce-BSK3KHpz.js";import"./transition-BJzcwH5q.js";import"./index-B2RZm-di.js";import"./form-provider-DAJmH35K.js";import"./TextField-C3GBty_k.js";import"./FormControl-CAeI9VZ6.js";import"./utils-DoM3o7-Q.js";import"./InputLabel-C4WXc4Lp.js";import"./formControlState-Dq1zat_P.js";import"./FormLabel-Co2KdlDF.js";import"./Select-aQYZH3TH.js";import"./Menu-eKJMgiWE.js";import"./InputBase-Lx9oX8L4.js";import"./FormHelperText-Bsh-3BCg.js";import"./Rating-CFU91EQa.js";import"./visuallyHidden-Dan1xhjv.js";import"./editor-CaGL4rG0.js";import"./index-l4VxMZSv.js";import"./Slider-Loskhemd.js";import"./RadioGroup-Dewy7eJk.js";import"./FormGroup-BEHuPMNZ.js";import"./FormControlLabel-DSmn4eUx.js";import"./utils-Be64QJhR.js";import"./countries-DSLisFCy.js";import"./InputAdornment-CZqtpVU7.js";import"./Autocomplete-UYjoJm2K.js";import"./Chip-Bqn7aPqU.js";import"./country-select-BHdsHhaW.js";import"./Checkbox-Dv9DB-8I.js";import"./upload-avatar-DBJlPSVT.js";import"./image-BlOEV0mO.js";import"./DatePicker-DL9s210N.js";import"./DialogContent-CB7Unwzu.js";import"./ListItem-DjRfQpUp.js";import"./MobileDateTimePicker-UNDcqYl2.js";import"./Tabs-D2MBqKqb.js";import"./KeyboardArrowRight-C_h4tT89.js";import"./upload-box-ad-SVVPU0VR.js";import"./schema-helper-BulHfCPD.js";import"./DialogTitle-CUFjdCkA.js";import"./LoadingButton-DsnjjvCJ.js";import"./table-head-custom-DVdNqcUm.js";import"./TableCell-Lyd9zWIr.js";import"./incrementer-button-C2nyBf6u.js";const Pt=({order:e,payments:n,dialog:s,handleApproveOrder:p,handlePrint:r})=>{const T=t.jsxs(a,{sx:{pr:4,pl:4,pb:4,pt:2},children:[t.jsx(jt,{sx:{p:0,m:0,[`& .${yt.root}:before`]:{flex:0,padding:0}},children:n==null?void 0:n.map((x,m)=>{const d=m===0,j=m===n.length-1;return t.jsxs(ft,{children:[t.jsxs(gt,{children:[t.jsx(bt,{color:d&&"primary"||"grey"}),j?null:t.jsx(Dt,{})]}),t.jsx(wt,{children:t.jsxs(a,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between"},children:[t.jsxs(a,{children:[t.jsxs(a,{display:"flex",alignItems:"center",gap:1,children:[t.jsx(Y,{variant:"subtitle2",children:R(x.amount)}),x.isChanged&&t.jsx(D,{title:"has been modified!",children:t.jsx(u,{sx:{color:"warning.main"},width:18,icon:"eos-icons:content-modified"})})]}),t.jsx(a,{sx:{color:"text.disabled",typography:"caption",mt:.5},children:J(x.paymentDate)})]}),t.jsx(_,{color:"success",children:x.paymentType})]})})]},x.id)})}),t.jsx(l,{justifyContent:"flex-end",spacing:1.5,sx:{marginTop:2},children:(e==null?void 0:e.status)!==c.Draft&&(e==null?void 0:e.status)!==c.Canceled&&(Math.round(H(e.totalOrderAmount-e.totalOrderAmount*(e.discount/100),e==null?void 0:e.snapshotTaxPercentage)-e.orderPaymentAmount)>0?t.jsx(k,{permission:S.ADD_PAYMENT,children:t.jsx(E,{variant:"contained",onClick:()=>s.onTrue(),startIcon:t.jsx(u,{icon:"mingcute:add-line"}),children:"New Payment"})}):t.jsx(E,{variant:"contained",color:"success",sx:{cursor:"not-allowed"},startIcon:t.jsx(u,{icon:"solar:check-read-bold-duotone"}),children:"Payed"}))})]});return t.jsxs(G,{children:[(n==null?void 0:n.length)>0&&t.jsx(W,{title:"Payments"}),T]})};function vt({order:e,discount:n,customer:s,totalAmount:p,handleApproveOrder:r,handlePrint:T}){var P,i,v,O;M("orders");const{user:x}=X(),m=Z(),d=h.useCallback(o=>{m.replace(q.dashboard.quotation.details(o))},[m]),j=t.jsxs(l,{spacing:2,alignItems:"flex-end",sx:{p:3,textAlign:"right",typography:"body2"},children:[t.jsxs(l,{direction:"row",children:[t.jsx(a,{sx:{color:"text.secondary"},children:"Subtotal"}),t.jsx(a,{sx:{width:160,typography:"subtitle2"},children:R(p)||"-"})]}),t.jsxs(l,{direction:"row",children:[t.jsx(a,{sx:{color:"text.secondary"},children:"Discount"}),t.jsx(a,{sx:{width:160,...n&&{color:"error.main"}},children:n?`- ${n}%`:"-"})]}),t.jsxs(l,{direction:"row",children:[t.jsxs(a,{sx:{color:"text.secondary"},children:["Tax (",(e==null?void 0:e.snapshotTaxPercentage)||"0","%)"]}),t.jsx(a,{sx:{width:160},children:e!=null&&e.snapshotTaxPercentage?R(tt(p-p*(n/100),e==null?void 0:e.snapshotTaxPercentage)):"-"})]}),t.jsxs(l,{direction:"row",sx:{typography:"subtitle1"},children:[t.jsx("div",{children:"Total"}),t.jsx(a,{sx:{width:160},children:R(H(p-p*(n/100),e==null?void 0:e.snapshotTaxPercentage))||"-"})]})]}),y=K(),[f,g]=h.useState(!1),B=()=>{g(!0)},{isLoading:F}=U({queryKey:["download-order",e.id],queryFn:async()=>{const o=await w.get(C.order.downloadPdf+e.id,{responseType:"blob"}),z=window.URL.createObjectURL(new Blob([o.data])),b=document.createElement("a");return b.href=z,b.setAttribute("download",`Order-${e.ref}.pdf`),document.body.appendChild(b),b.click(),document.body.removeChild(b),g(!1),o.data},enabled:f,onSuccess:()=>{g(!1)},onError:o=>{console.error("Download failed:",o)}}),I=t.jsx(D,{title:"Download Pdf",children:t.jsx(V,{onClick:B,children:F?t.jsx(Tt,{size:24,color:"inherit"}):t.jsx(u,{icon:"eva:cloud-download-fill",color:"error.main"})})});return t.jsxs(t.Fragment,{children:[t.jsxs(G,{children:[t.jsx(l,{justifyContent:"center",alignItems:"center",children:t.jsxs("h1",{className:"print-title",children:["Order REF: #",e.ref]})}),t.jsx("style",{jsx:!0,children:`
          .print-title {
            display: none; /* Hide on screen */
          }

          @media print {
            .print-title {
              display: block; /* Show only when printing */
            }
            .print-hide {
              display: none; /* Hide on screen */
            }
            html,
            body {
              height: initial !important;
              overflow: initial !important;
            }

            .scrollableDiv {
              width: 100%;
              height: 100% !important;
              overflow: visible;
            }
          }
        `}),t.jsx(W,{className:"print-hide",title:"Details",subheader:((P=e==null?void 0:e.quotation)==null?void 0:P.id)&&`Related to Quotation: #${(i=e==null?void 0:e.quotation)==null?void 0:i.ref}`,action:t.jsx(l,{className:"print-hide",children:t.jsxs(l,{direction:"row",spacing:1,flexGrow:1,children:[((v=e==null?void 0:e.quotation)==null?void 0:v.id)&&t.jsx(D,{title:`Related to Quotation: #${(O=e==null?void 0:e.quotation)==null?void 0:O.ref}`,children:t.jsx(V,{onClick:()=>{var o;d((o=e==null?void 0:e.quotation)==null?void 0:o.id)},children:t.jsx(u,{icon:"heroicons-outline:external-link"})})}),t.jsx(k,{permission:S.ORDER_STATUS_SCREEN_DRAG_AND_DROP,children:(e==null?void 0:e.status)!==c.Draft&&(e==null?void 0:e.status)!==c.Canceled&&t.jsx(D,{title:"Change Order Status",children:t.jsx(V,{onClick:()=>y.onToggle(),children:t.jsx(u,{icon:"tabler:status-change"})})})}),I,t.jsx(k,{permission:S.PRINT_ORDER,children:t.jsx(D,{title:"Print",children:t.jsx(dt,{order:e})})}),t.jsx(k,{permission:S.APPROVE_ORDER,children:(e==null?void 0:e.status)===c.Draft&&t.jsx(E,{variant:"contained",size:"medium",color:"info",startIcon:t.jsx(u,{icon:"material-symbols:order-approve"}),onClick:()=>{r(e.id)},children:"Click to Approve"})})]})})}),t.jsxs(l,{display:"grid",gridTemplateColumns:{xs:"repeat(2, 1fr)",sm:"repeat(3, 1fr)",md:"repeat(3, 1fr)",lg:"repeat(3, 1fr)"},sx:{p:2,typography:"body2"},children:[t.jsxs(a,{flexDirection:"column",sx:{display:"flex",width:"100%",p:1},children:[t.jsx(l,{display:"flex",gap:1,sx:{typography:"subtitle2",width:"100%",marginBottom:1},children:t.jsx("div",{children:"Order Details"})}),t.jsxs(a,{sx:{color:"text.secondary"},children:["ORDER ID: #",e.ref]}),t.jsxs(a,{sx:{color:"text.secondary"},children:["Order Date: ",L(e.orderDate)]}),t.jsxs(a,{sx:{color:"text.secondary"},children:["Delivery Date: ",e.deliveryDate?L(e.deliveryDate):t.jsx("span",{children:" - "})]})]}),t.jsxs(a,{flexDirection:"column",sx:{display:"flex",width:1,p:1,borderRight:o=>`dashed 2px ${o.vars.palette.background.neutral}`,borderLeft:o=>`dashed 2px ${o.vars.palette.background.neutral}`},children:[t.jsx(l,{display:"flex",justifyContent:"center",sx:{typography:"subtitle2",width:"100%",marginBottom:1},children:t.jsx("div",{children:et(x)})}),t.jsxs(a,{sx:{color:"text.secondary"},children:["Status:"," ",t.jsx(_,{variant:"soft",color:(e==null?void 0:e.status)===c.Ready&&"info"||(e==null?void 0:e.status)===c.InProcess&&"warning"||(e==null?void 0:e.status)===c.Delivered&&"success"||(e==null?void 0:e.status)===c.Canceled&&"error"||"default",children:e==null?void 0:e.status})]}),t.jsxs(a,{sx:{color:"text.secondary"},children:["Tax/Vat: ",s==null?void 0:s.taxNumber]})]}),t.jsxs(a,{flexDirection:"column",sx:{display:"flex",width:"100%",p:1},children:[t.jsx(l,{display:"flex",gap:1,sx:{typography:"subtitle2",width:"100%",marginBottom:1},children:t.jsx("div",{children:"Order To"})}),t.jsxs(a,{sx:{color:"text.secondary",textTransform:"capitalize"},children:["Customer: ",s==null?void 0:s.name]}),t.jsxs(a,{sx:{color:"text.secondary"},children:["Tel: ",s==null?void 0:s.phoneNumber]})]})]}),t.jsx(a,{fullWidth:!0,alignItems:"center",sx:{p:2,borderBottom:o=>`dashed 2px ${o.vars.palette.background.neutral}`},children:t.jsx(Ct,{products:e.productToOrder,isDetail:!0})}),j,(e==null?void 0:e.notes)&&t.jsx(l,{justifyContent:"space-between",sx:{p:3,typography:"body2"},children:t.jsxs(a,{flexDirection:"column",sx:{display:"flex",width:"100%",p:1},children:[t.jsx(l,{sx:{typography:"subtitle2",marginBottom:1},children:t.jsx("div",{children:"Notes:"})}),t.jsx(a,{sx:{color:"text.secondary"},children:e==null?void 0:e.notes})]})})]}),t.jsx(pt,{currentOrder:e,open:y.value,onClose:y.onFalse})]})}function Ot({currentOrder:e}){const{t:n}=M("orders"),[s,p]=h.useState(e),[r,T]=h.useState(),x=h.useRef(),m=K(),d=st(),[j,y]=h.useState([]),f=K(),g=it();h.useEffect(()=>{p(e)},[e]),h.useEffect(()=>{const i=$(s==null?void 0:s.payments,"paymentDate");y(i)},[s==null?void 0:s.payments]);const{mutate:B}=N({mutationFn:i=>w.post(C.payments.create,i),onSuccess:async i=>{Q.success(n("detailView.orderPaymentDialog.submitButton"));const{data:v}=i,O=$([...j,v],"paymentDate");y(O)},onSettled:async()=>{await d.invalidateQueries({queryKey:["payments"]});const{id:i}=s;await d.invalidateQueries({queryKey:["order",i]}),m.onFalse()},onError:i=>{console.log(i)}}),{mutate:F}=N({mutationFn:i=>w.get(C.order.approve+i),onSuccess:async({data:i})=>{i!=null&&i.length?(f.onTrue(),T(i)):(Q.success(n("detailView.orderDetails.approveOrderButton")),p(i))},onSettled:async()=>{const{id:i}=s;await d.invalidateQueries({queryKey:["orders"]}),await d.invalidateQueries({queryKey:["orders","analytics"]}),await d.invalidateQueries({queryKey:["order",i]})},onError:i=>{console.log(i)}}),{mutate:I}=N({mutationFn:i=>w.post(C.order.createPlans,i),onSuccess:async({data:i})=>{Q.success(n("detailView.orderDetails.approveOrderButton")),p(i),f.onFalse()},onSettled:async()=>{const{id:i}=s;await d.invalidateQueries({queryKey:["orders"]}),await d.invalidateQueries({queryKey:["orders","analytics"]}),await d.invalidateQueries({queryKey:["order",i]})},onError:i=>{console.log(i)}}),P=mt.useReactToPrint({content:()=>x.current});return t.jsxs(t.Fragment,{children:[t.jsxs(nt,{children:[t.jsx(ut,{links:[{name:n("detailView.breadCrumbsPageRootTitle"),href:q.dashboard.root},{name:n("detailView.breadCrumbsParentPageTitle"),href:q.dashboard.order.root},{name:n("detailView.breadCrumbsPageTitle")}],sx:{mb:{xs:3,md:5}}}),t.jsxs(A,{container:!0,spacing:3,children:[t.jsx(A,{xs:12,md:(s==null?void 0:s.status)!==c.Draft&&(s==null?void 0:s.status)!==c.Canceled?9:12,children:t.jsx(l,{ref:x,spacing:3,direction:{xs:"column-reverse",md:"column"},children:t.jsx(vt,{order:s,customer:s==null?void 0:s.customer,discount:s==null?void 0:s.discount,totalAmount:s==null?void 0:s.totalOrderAmount,handleApproveOrder:F,handlePrint:P})})}),(s==null?void 0:s.status)!==c.Draft&&(s==null?void 0:s.status)!==c.Canceled&&t.jsx(A,{xs:12,md:3,children:t.jsx(Pt,{order:s,payments:j,dialog:m})})]}),t.jsx(xt,{order:s,open:m.value,onClose:m.onFalse,handler:B})]}),t.jsx(ht,{open:f.value,onClose:f.onFalse,title:n("detailView.confirmDialog.outOfStockTitle"),content:t.jsxs(t.Fragment,{children:[t.jsx(a,{children:n("detailView.confirmDialog.outOfStockMessage")}),t.jsxs(a,{sx:{mt:1,mb:1},children:[n("detailView.confirmDialog.createPlanPrefix"),t.jsx("span",{style:{fontWeight:"bold"},children:r==null?void 0:r.length}),n("detailView.confirmDialog.createPlanSuffix")]}),r==null?void 0:r.map(i=>t.jsxs(a,{children:[n("detailView.confirmDialog.planDetails.planFor"),t.jsx("span",{style:{fontWeight:"bold"},children:i.product.name})," ",n("detailView.confirmDialog.planDetails.missingQuantity"),t.jsx("span",{style:{fontWeight:"bold",color:`${g.vars.palette.error.light}`},children:i.missingQuantity}),"."]}))]}),action:t.jsx(E,{variant:"contained",color:"error",onClick:()=>{I(r)},children:(r==null?void 0:r.length)>1?n("detailView.confirmDialog.planDetails.createPlansButton"):n("detailView.confirmDialog.planDetails.createPlanButton")})})]})}const St={title:`Order details | Dashboard - ${ot.site.name}`};function Ie(){const{id:e=""}=ct(),n=U({queryKey:["order",e],queryFn:async()=>{const{data:s}=await w.get(C.order.details+e);return s}});return n.isPending||n.isLoading?t.jsx(at,{}):n.isError?t.jsx(rt,{route:q.dashboard.order.root}):t.jsxs(t.Fragment,{children:[t.jsx(lt,{children:t.jsxs("title",{children:[" ",St.title]})}),t.jsx(Ot,{currentOrder:n.data})]})}export{Ie as default};

import{i as b,r as o,g as be,aW as B,dn as Se,dp as h,dm as g,dq as N,p as w,j as t,cY as A,S as l,B as n,I as R,C as W,v as we,ea as Ie,e8 as Te,aS as L,e as F,cV as E,dP as Fe,dT as Ee,H as ke}from"./index-CFpFDdmk.js";import{u as S,E as Ye}from"./error-block-Qb0JqWMo.js";import{u as Oe}from"./use-params-B-FmzFVH.js";import{C as ve}from"./custom-breadcrumbs-BhZ5AQiJ.js";import{u as H}from"./useMutation-BYxzZEeu.js";import{b as k}from"./format-number-u5v8ow11.js";import{u as Qe}from"./use-table-DRwUskxu.js";import{O as Me,a as Be,I as Ne}from"./order-discount-product-dialog-BLrNYdf4.js";import{P as Ae}from"./product-Item-button-iWuQ-HfF.js";import{C as Re}from"./component-pagination-custom-QfPhwL3x.js";import{O as Le}from"./order-product-table-C2Fek4-R.js";import{O as He}from"./order-customer-create-dialog-COF-Wwtz.js";import{T as Ke}from"./TextField-DfM7FsMT.js";import{I as We}from"./InputAdornment-CgLiqxs-.js";import{F as qe}from"./FormControl-CNS-_KcR.js";import{S as $e}from"./Select-BlD-2uiB.js";import{F as Ge}from"./FormHelperText-CBSty0_k.js";import{D as K}from"./DatePicker--R0iVwy6.js";import"./utils-km2FGkQ4.js";import"./bounce-BSK3KHpz.js";import"./transition-BJzcwH5q.js";import"./DialogContent-__vH1XwO.js";import"./DialogTitle-Fqo4pdu1.js";import"./form-provider-BpZ_lNCz.js";import"./Rating-hRCFGB57.js";import"./visuallyHidden-Dan1xhjv.js";import"./editor-B84uWKaP.js";import"./Menu-B68-fR6c.js";import"./index-C97vZu8v.js";import"./Slider-1GT9TVwO.js";import"./FormLabel-DSBvpxE-.js";import"./formControlState-Dq1zat_P.js";import"./RadioGroup-q3osZweo.js";import"./FormGroup-cGoNpeSS.js";import"./FormControlLabel-Djcc_FaA.js";import"./utils-BeBWERKu.js";import"./index-iy408cV1.js";import"./countries-DSLisFCy.js";import"./Autocomplete-CiqUWkUt.js";import"./Chip-B8Kj4THB.js";import"./country-select-B5_N9Ghb.js";import"./InputLabel-D-P4ONWN.js";import"./Checkbox-BgUXlmGv.js";import"./upload-avatar-CpOCvI_m.js";import"./image-DogZHW8e.js";import"./MobileDateTimePicker-iVybONG-.js";import"./Tabs-mH73uY_b.js";import"./KeyboardArrowRight-BWeVAAgH.js";import"./TablePagination-Bod9RAXB.js";import"./LastPage-B91oXYll.js";import"./TableCell-nk9uECyp.js";import"./InputBase-BlPzdlBf.js";import"./utils-DoM3o7-Q.js";import"./table-head-custom-BYdbhTGG.js";import"./incrementer-button-C-kwnl1h.js";import"./schema-helper-4wDMemZN.js";import"./LoadingButton-DIpeLunE.js";import"./CircularProgress-kusugyBo.js";import"./ListItem-C2-cLBAD.js";function Ve({quotation:r,products:d,customers:x,taxPercentage:u}){var M;const a=Qe({defaultRowsPerPage:6}),c=b(),D=b(),P=b(),Y=b(),[q,$]=o.useState(""),[G,V]=o.useState(""),z=be(),[J,U]=o.useState(r==null?void 0:r.name),[f,X]=o.useState(r==null?void 0:r.discount),[Z,_]=o.useState(0),[I,C]=o.useState(!1),[ee,te]=o.useState(),[j,se]=o.useState((M=r==null?void 0:r.customer)==null?void 0:M.id),[T,re]=o.useState(B(r==null?void 0:r.quotationDate)),[oe,ae]=o.useState(B(r==null?void 0:r.expiredDate)),[i,m]=o.useState([]),[O,v]=o.useState(d);o.useEffect(()=>{const e=[];for(const s of r==null?void 0:r.productToQuotation){const p={...s.product,quantity:s.quantity,discount:s.discount||0,price:s==null?void 0:s.snapshotProductPrice,snapshotProductPrice:s==null?void 0:s.price};e.push(p)}m(e)},[r]);const Q=Se(),ne=(e,s)=>{_(s),te(e),P.onToggle()},ie=e=>{X(e),D.onFalse()},ce=(e,s)=>{m(p=>(p[e].price=s,[...p])),P.onFalse()},{mutate:le}=H({mutationFn:({id:e,payload:s})=>h.patch(g.quotation.edit+e,s),onSuccess:async()=>{N.success("New Quotation Has Been Created!"),await Q.invalidateQueries({queryKey:["quotations"]})},onSettled:async()=>{z.push(w.dashboard.quotation.root)},onError:e=>{console.error(e)}});o.useCallback(e=>{U(e.target.value)},[]);const de=o.useCallback(e=>{se(e.target.value),e.target.value==="Customer"?C(!0):C(!1)},[]),ue=o.useCallback(e=>{m(s=>{const p=s.findIndex(Pe=>Pe.id===e.id);return p>=0?s[p].quantity+=1:(e.quantity=1,e.discount=0,s.push(e)),[...s]})},[]),me=o.useCallback(e=>{const s=e.target.value;s&&v(d.filter(p=>p.name.toLowerCase().indexOf(s)!==-1)),(s==null||s==="")&&v(d)},[]),pe=o.useCallback(e=>{m(s=>(s[e].quantity-=1,s[e].quantity===0&&s.splice(e,1),[...s]))},[i]),xe=o.useCallback(e=>{m(s=>(s[e].discount>0&&(s[e].discount-=1),[...s]))},[]),he=o.useCallback(e=>{m(s=>(s[e].discount<100&&(s[e].discount+=1),[...s]))},[]),ge=o.useCallback(e=>{m(s=>(s[e].quantity+=1,[...s]))},[i]),fe=o.useCallback(e=>{m(s=>(s.splice(e,1),[...s]))},[i]),y=o.useCallback(()=>i.reduce((e,s)=>e+s.price*s.quantity,0),[i]);o.useCallback(()=>i.reduce((e,s)=>e+s.price*(s.discount/100)*s.quantity,0),[i]);const{mutate:Ce}=H({mutationFn:e=>h.post(g.customers.create,e),onSuccess:async()=>{N.success("New Customer Has Been Created!")},onSettled:async()=>{await Q.invalidateQueries({queryKey:["customers"]}),c.onFalse()},onError:e=>{console.log(e)}}),je=t.jsx(A,{children:t.jsxs(l,{children:[t.jsx(n,{sx:{p:3},children:t.jsx(Ke,{color:"success",fullWidth:!0,maxWidth:"xs",placeholder:"Search product...",InputProps:{startAdornment:t.jsx(We,{position:"start",children:t.jsx(R,{icon:"eva:search-fill",sx:{color:"text.disabled"}})})},onChange:me})}),t.jsx(n,{sx:{pl:3,pr:3},gap:1,display:"grid",gridTemplateColumns:{xs:"repeat(2, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(2, 1fr)",lg:"repeat(2, 1fr)"},children:O.slice(a.page*a.rowsPerPage,a.page*a.rowsPerPage+a.rowsPerPage).map(e=>t.jsx(Ae,{payload:e,handleClick:ue,productName:e==null?void 0:e.name,image:W.site.serverFileHost+(e==null?void 0:e.image)},e==null?void 0:e.id))}),t.jsx(Re,{page:a.page,count:O.length,rowsPerPage:6,defaultRowsPerPage:6,onPageChange:a.onChangePage,onRowsPerPageChange:a.onChangeRowsPerPage})]})}),ye=t.jsxs(l,{spacing:2,alignItems:"flex-end",sx:{p:2,textAlign:"right",typography:"body2"},children:[t.jsxs(l,{direction:"row",children:[t.jsx(n,{sx:{color:"text.secondary"},children:"Subtotal"}),t.jsx(n,{sx:{width:160,typography:"subtitle2"},children:k(y())||"-"})]}),t.jsxs(l,{direction:"row",alignItems:"center",children:[t.jsx(n,{sx:{color:"text.secondary"},children:"Discount"}),t.jsx(n,{sx:{width:160},children:t.jsx(n,{sx:{pl:4,mr:-.5},children:t.jsxs(l,{onClick:()=>{D.onToggle()},sx:{cursor:"pointer",p:.5,color:"error.main",borderRadius:1,typography:"subtitle2",border:e=>`solid 1px ${we(e.vars.palette.grey["500Channel"],.2)}`},children:[f,"%"]})})})]}),t.jsxs(l,{direction:"row",children:[t.jsxs(n,{sx:{color:"text.secondary"},children:["Tax (",u||"0","%)"]}),t.jsx(n,{sx:{width:160},children:u?k(Ie(y()-y()*(f/100),u)):"-"})]}),t.jsxs(l,{direction:"row",sx:{typography:"subtitle1"},children:[t.jsx("div",{children:"Total:"}),t.jsx(n,{sx:{width:160},children:k(Te(y()-y()*(f/100),u))||"-"})]})]}),De=t.jsx(A,{children:t.jsxs(l,{spacing:2,sx:{p:3},children:[t.jsxs(n,{display:"grid",gap:2,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(1, 1fr)",md:"repeat(2, 1fr)",lg:"repeat(2, 1fr)"},children:[t.jsxs(qe,{sx:{m:1,minWidth:120},error:I&&!j,children:[t.jsxs($e,{sx:{maxWidth:420,textTransform:"capitalize"},value:j,error:I,onChange:de,children:[t.jsx(L,{value:"Customer",children:"Customer"}),x.map(e=>t.jsx(L,{value:e.id,children:e.name},e.id))]}),I&&t.jsx(Ge,{error:!0,children:"Customer is required!"})]}),t.jsx(n,{display:"flex",justifyContent:"flex-end",alignItems:"center",children:t.jsx(F,{variant:"contained",startIcon:t.jsx(R,{icon:"mingcute:add-line"}),onClick:()=>c.onToggle(),children:"New Customer"})}),t.jsx(K,{label:"Date",sx:{mt:2},format:"DD/MM/YYYY",value:T,onChange:e=>{re(e)}}),t.jsx(K,{label:"Expiry",sx:{mt:2},format:"DD/MM/YYYY",value:T,onChange:e=>{ae(e)}})]}),t.jsx(Le,{products:i,onDecrease:pe,onIncrease:ge,onDecreaseDiscount:xe,onIncreaseDiscount:he,handleDiscountDialog:ne,removeItem:fe}),t.jsxs(n,{display:"flex",flexDirection:"column",alignItems:"flex-end",justifyContent:"center",children:[ye,t.jsxs(n,{display:"flex",gap:2,height:50,children:[t.jsx(F,{variant:"contained",onClick:()=>{if(isNaN(parseInt(j))){C(!0);return}if(C(!1),!i.length){$("Something went wrong. Product(s) are required!"),V("You need to add at least one product to this quotation. Please select a product from the list on the right."),Y.onToggle();return}if(!isNaN(parseInt(j))&&i.length){C(!1);const e={discount:parseInt(f,10),name:J,quotationDate:T.format("YYYY-MM-DD"),expiredDate:oe.format("YYYY-MM-DD"),products:i.map(s=>({id:s.id,snapshotProductPrice:s.price,quantity:s.quantity})),customer:j};le({id:r.id,payload:e})}},children:"Save and Continue"}),t.jsx(F,{variant:"outlined",onClick:()=>m([]),children:"Clear All"})]})]})]})});return t.jsxs(E,{container:!0,spacing:3,children:[t.jsx(E,{xs:12,md:3,children:t.jsx(l,{children:je})}),t.jsx(E,{xs:12,md:9,children:t.jsx(l,{children:De})}),t.jsx(He,{open:c.value,onClose:c.onFalse,handler:Ce}),t.jsx(Me,{discount:f,open:D.value,onClose:D.onFalse,handler:ie}),t.jsx(Be,{product:ee,discount:Z,open:P.value,onClose:P.onFalse,handler:ce}),t.jsx(Ne,{dialog:Y,title:q,contentText:G})]})}function ze({quotation:r,products:d,customers:x,taxPercentage:u}){const a=`Edit Quotation: #${r.ref}`;return t.jsxs(Fe,{children:[t.jsx(ve,{heading:a,links:[{name:"Dashboard",href:w.dashboard.root},{name:"Quotation",href:w.dashboard.quotation.root},{name:"Edit Quotation"}],sx:{mb:{xs:3,md:5}}}),t.jsx(Ve,{quotation:r,products:d,customers:x,taxPercentage:u})]})}const Je={title:`Quotation Edit | Dashboard - ${W.site.name}`};function ts(){const{id:r=""}=Oe(),d=S({queryKey:["quotation",r],queryFn:async()=>{const{data:c}=await h.get(g.quotation.details+r);return c}}),x=S({queryKey:["products"],queryFn:async()=>(await h.get(g.products.list)).data}),u=S({queryKey:["customers"],queryFn:async()=>(await h.get(g.customers.list)).data}),a=S({queryKey:["account-application"],queryFn:async()=>{const{data:c}=await h.get(g.auth.application);return c}});return d.isLoading||a.isLoading||x.isLoading||u.isLoading?t.jsx(Ee,{}):d.isError||a.isError||x.isError||x.isError?t.jsx(Ye,{route:w.dashboard.quotation.root}):t.jsxs(t.Fragment,{children:[t.jsx(ke,{children:t.jsxs("title",{children:[" ",Je.title]})}),t.jsx(ze,{quotation:d.data,products:x.data,customers:u.data,taxPercentage:a.data.taxPercentage})]})}export{ts as default};

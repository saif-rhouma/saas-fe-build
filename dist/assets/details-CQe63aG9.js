import{br as K,j as e,B as l,T as J,bq as b,I as j,eh as X,d8 as W,S as r,ef as o,e8 as G,e4 as v,e as R,cZ as U,X as Z,W as ee,r as h,p as k,ea as te,Y as N,dq as T,dn as C,$ as I,d1 as M,ei as se,dp as ie,eb as ae,ej as _,dQ as ne,cW as F,dr as $,dU as le,H as oe,C as re}from"./index-BqQARj70.js";import{u as z,E as ce}from"./error-block-Cvsq6LVS.js";import{u as de}from"./use-params-C27m3orW.js";import"./chart-legends-BviC35__.js";import{P as xe,a as pe,O as ue}from"./order-status-dialog-BTdW3KAi.js";import{l as me}from"./index-DWH8agZA.js";import{u as Q}from"./useMutation-D9b-SBJX.js";import{C as he}from"./confirm-dialog-D-kAfeIE.js";import{C as je}from"./custom-breadcrumbs-ryDpeVg5.js";import{b as O}from"./format-number-BvEweN_e.js";import{P as S}from"./permission-access-controller-Q9flSCkz.js";import{T as ye,t as fe,a as ge,b as we,c as De,d as be,e as Te}from"./TimelineSeparator-BscZCaNm.js";import{C as H}from"./CardHeader-DXB_c6fw.js";import{O as Ce}from"./order-product-table-GgygIUT3.js";import{C as Pe}from"./CircularProgress-CnEecEq8.js";import"./utils-km2FGkQ4.js";import"./bounce-BSK3KHpz.js";import"./transition-BJzcwH5q.js";import"./index-ALNGUIW9.js";import"./form-provider-ccfU2XUN.js";import"./TextField-Ddc-2_B3.js";import"./FormControl-C8LIfacH.js";import"./utils-DoM3o7-Q.js";import"./InputLabel-Cypnw6Fi.js";import"./formControlState-Dq1zat_P.js";import"./FormLabel-Dza6C49E.js";import"./Select-BcNE4CY6.js";import"./Menu-CyG4g8V9.js";import"./InputBase-ByUog9Qa.js";import"./FormHelperText-D7zaUcMu.js";import"./Rating-CRHSMtZR.js";import"./visuallyHidden-Dan1xhjv.js";import"./editor-QJd8noTi.js";import"./index-3on3wy4W.js";import"./Slider-CY1kJa8b.js";import"./RadioGroup-ChlGooHA.js";import"./FormGroup-CXDpwB7j.js";import"./FormControlLabel-DYa7_yhu.js";import"./utils-BkGDLkaZ.js";import"./countries-DSLisFCy.js";import"./InputAdornment-BfS4czl_.js";import"./Autocomplete-mVzVA2ZY.js";import"./Chip-DPBTbqGw.js";import"./country-select-BdT_Z9O2.js";import"./Checkbox-Bhx6CUcB.js";import"./upload-avatar-rmFzksOv.js";import"./image-D-bc4Fg4.js";import"./DatePicker-Ce3HVs4j.js";import"./DialogContent-Bu9AzrBB.js";import"./ListItem-D-3kOQEW.js";import"./MobileDateTimePicker-huLGYsGv.js";import"./Tabs-CmqXMWlF.js";import"./KeyboardArrowRight-CBFHahxG.js";import"./upload-box-ad-BJDkBjwT.js";import"./schema-helper-BD6wlizp.js";import"./DialogTitle-rK5KahkH.js";import"./LoadingButton-F-RhBSUA.js";import"./table-head-custom-BsfRnN01.js";import"./TableCell-BYUYO2qG.js";import"./incrementer-button-8gy3nd8i.js";const Ve=({order:t,payments:a,dialog:s,handleApproveOrder:u,handlePrint:x})=>{const{t:y}=K("orders"),n=e.jsxs(l,{sx:{pr:4,pl:4,pb:4,pt:2},children:[e.jsx(ye,{sx:{p:0,m:0,[`& .${fe.root}:before`]:{flex:0,padding:0}},children:a==null?void 0:a.map((p,d)=>{const f=d===0,g=d===a.length-1;return e.jsxs(ge,{children:[e.jsxs(we,{children:[e.jsx(De,{color:f&&"primary"||"grey"}),g?null:e.jsx(be,{})]}),e.jsx(Te,{children:e.jsxs(l,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(l,{children:[e.jsxs(l,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(J,{variant:"subtitle2",children:O(p.amount)}),p.isChanged&&e.jsx(b,{title:"has been modified!",children:e.jsx(j,{sx:{color:"warning.main"},width:18,icon:"eos-icons:content-modified"})})]}),e.jsx(l,{sx:{color:"text.disabled",typography:"caption",mt:.5},children:X(p.paymentDate)})]}),e.jsx(W,{color:"success",children:p.paymentType})]})})]},p.id)})}),e.jsx(r,{justifyContent:"flex-end",spacing:1.5,sx:{marginTop:2},children:(t==null?void 0:t.status)!==o.Draft&&(t==null?void 0:t.status)!==o.Canceled&&(Math.round(G(t.totalOrderAmount-t.totalOrderAmount*(t.discount/100),t==null?void 0:t.snapshotTaxPercentage)-t.orderPaymentAmount)>0?e.jsx(S,{permission:v.ADD_PAYMENT,children:e.jsx(R,{variant:"contained",onClick:()=>s.onTrue(),startIcon:e.jsx(j,{icon:"mingcute:add-line"}),children:y("detailView.orderProductAddons.newPaymentButton")})}):e.jsx(R,{variant:"contained",color:"success",sx:{cursor:"not-allowed"},startIcon:e.jsx(j,{icon:"solar:check-read-bold-duotone"}),children:y("detailView.orderProductAddons.payed")}))})]});return e.jsxs(U,{children:[(a==null?void 0:a.length)>0&&e.jsx(H,{title:y("detailView.orderProductAddons.payments")}),n]})};function ve({order:t,discount:a,customer:s,totalAmount:u,handleApproveOrder:x,handlePrint:y}){var i,P,V,L;const{t:n}=K("orders"),{user:p}=Z(),d=ee(),f=h.useCallback(c=>{d.replace(k.dashboard.quotation.details(c))},[d]),g=e.jsxs(r,{spacing:2,alignItems:"flex-end",sx:{p:3,textAlign:"right",typography:"body2"},children:[e.jsxs(r,{direction:"row",children:[e.jsx(l,{sx:{color:"text.secondary"},children:n("detailView.orderDetails.subtotal")}),e.jsx(l,{sx:{width:160,typography:"subtitle2"},children:O(u)||"-"})]}),e.jsxs(r,{direction:"row",children:[e.jsx(l,{sx:{color:"text.secondary"},children:n("detailView.orderDetails.discount")}),e.jsx(l,{sx:{width:160,...a&&{color:"error.main"}},children:a?`- ${a}%`:"-"})]}),e.jsxs(r,{direction:"row",children:[e.jsxs(l,{sx:{color:"text.secondary"},children:[n("detailView.orderDetails.tax")," (",(t==null?void 0:t.snapshotTaxPercentage)||"0","%)"]}),e.jsx(l,{sx:{width:160},children:t!=null&&t.snapshotTaxPercentage?O(te(u-u*(a/100),t==null?void 0:t.snapshotTaxPercentage)):"-"})]}),e.jsxs(r,{direction:"row",sx:{typography:"subtitle1"},children:[e.jsx("div",{children:n("detailView.orderDetails.total")}),e.jsx(l,{sx:{width:160},children:O(G(u-u*(a/100),t==null?void 0:t.snapshotTaxPercentage))||"-"})]})]}),m=N(),[q,w]=h.useState(!1),A=()=>{w(!0)},{isLoading:E}=z({queryKey:["download-order",t.id],queryFn:async()=>{const c=await T.get(C.order.downloadPdf+t.id,{responseType:"blob"}),Y=window.URL.createObjectURL(new Blob([c.data])),D=document.createElement("a");return D.href=Y,D.setAttribute("download",`Order-${t.ref}.pdf`),document.body.appendChild(D),D.click(),document.body.removeChild(D),w(!1),c.data},enabled:q,onSuccess:()=>{w(!1)},onError:c=>{console.error("Download failed:",c)}}),B=e.jsx(b,{title:"Download Pdf",children:e.jsx(I,{onClick:A,children:E?e.jsx(Pe,{size:24,color:"inherit"}):e.jsx(j,{icon:"eva:cloud-download-fill",color:"error.main"})})});return e.jsxs(e.Fragment,{children:[e.jsxs(U,{children:[e.jsx(r,{justifyContent:"center",alignItems:"center",children:e.jsxs("h1",{className:"print-title",children:[n("detailView.orderDetails.orderRef"),t.ref]})}),e.jsx(H,{className:"print-hide",title:"Details",subheader:((i=t==null?void 0:t.quotation)==null?void 0:i.id)&&`${n("detailView.orderDetails.relatedToQuotation")}${(P=t==null?void 0:t.quotation)==null?void 0:P.ref}`,action:e.jsx(r,{className:"print-hide",children:e.jsxs(r,{direction:"row",spacing:1,flexGrow:1,children:[((V=t==null?void 0:t.quotation)==null?void 0:V.id)&&e.jsx(b,{title:`${n("detailView.orderDetails.relatedToQuotation")}${(L=t==null?void 0:t.quotation)==null?void 0:L.ref}`,children:e.jsx(I,{onClick:()=>{var c;f((c=t==null?void 0:t.quotation)==null?void 0:c.id)},children:e.jsx(j,{icon:"heroicons-outline:external-link"})})}),e.jsx(S,{permission:v.ORDER_STATUS_SCREEN_DRAG_AND_DROP,children:(t==null?void 0:t.status)!==o.Draft&&(t==null?void 0:t.status)!==o.Canceled&&e.jsx(b,{title:"Change Order Status",children:e.jsx(I,{onClick:()=>m.onToggle(),children:e.jsx(j,{icon:"tabler:status-change"})})})}),B,e.jsx(S,{permission:v.PRINT_ORDER,children:e.jsx(b,{title:"Print",children:e.jsx(xe,{order:t})})}),e.jsx(S,{permission:v.APPROVE_ORDER,children:(t==null?void 0:t.status)===o.Draft&&e.jsx(R,{variant:"contained",size:"medium",color:"info",startIcon:e.jsx(j,{icon:"material-symbols:order-approve"}),onClick:()=>{x(t.id)},children:n("detailView.orderDetails.clickToApprove")})})]})})}),e.jsxs(r,{display:"grid",gridTemplateColumns:{xs:"repeat(2, 1fr)",sm:"repeat(3, 1fr)",md:"repeat(3, 1fr)",lg:"repeat(3, 1fr)"},sx:{p:2,typography:"body2"},children:[e.jsxs(l,{flexDirection:"column",sx:{display:"flex",width:"100%",p:1},children:[e.jsx(r,{display:"flex",gap:1,sx:{typography:"subtitle2",width:"100%",marginBottom:1},children:e.jsx("div",{children:n("detailView.orderDetails.title")})}),e.jsxs(l,{sx:{color:"text.secondary"},children:[n("detailView.orderDetails.orderRef"),t.ref]}),e.jsxs(l,{sx:{color:"text.secondary"},children:[n("detailView.orderDetails.orderDate"),M(t.orderDate)]}),e.jsxs(l,{sx:{color:"text.secondary"},children:[n("detailView.orderDetails.deliveryDate"),t.deliveryDate?M(t.deliveryDate):e.jsx("span",{children:" - "})]})]}),e.jsxs(l,{flexDirection:"column",sx:{display:"flex",width:1,p:1,borderRight:c=>`dashed 2px ${c.vars.palette.background.neutral}`,borderLeft:c=>`dashed 2px ${c.vars.palette.background.neutral}`},children:[e.jsx(r,{display:"flex",justifyContent:"center",sx:{typography:"subtitle2",width:"100%",marginBottom:1},children:e.jsx("div",{children:se(p)})}),e.jsxs(l,{sx:{color:"text.secondary"},children:[n("detailView.orderDetails.statusText"),e.jsxs(W,{variant:"soft",color:(t==null?void 0:t.status)===o.Ready&&"info"||(t==null?void 0:t.status)===o.InProcess&&"warning"||(t==null?void 0:t.status)===o.Delivered&&"success"||(t==null?void 0:t.status)===o.Canceled&&"error"||"default",children:[(t==null?void 0:t.status)===o.Draft&&`${n("listView.table.tableToolbar.selectMenu.draft")}`,(t==null?void 0:t.status)===o.InProcess&&`${n("listView.table.tableToolbar.selectMenu.processing")}`,(t==null?void 0:t.status)===o.Ready&&`${n("listView.table.tableToolbar.selectMenu.readyToDeliver")}`,(t==null?void 0:t.status)===o.Delivered&&`${n("listView.table.tableToolbar.selectMenu.delivered")}`,(t==null?void 0:t.status)===o.Canceled&&`${n("listView.table.tableToolbar.selectMenu.canceled")}`]})]}),e.jsxs(l,{sx:{color:"text.secondary"},children:[" ",n("detailView.orderDetails.taxVat"),s==null?void 0:s.taxNumber]})]}),e.jsxs(l,{flexDirection:"column",sx:{display:"flex",width:"100%",p:1},children:[e.jsx(r,{display:"flex",gap:1,sx:{typography:"subtitle2",width:"100%",marginBottom:1},children:e.jsx("div",{children:n("detailView.orderDetails.orderTo")})}),e.jsxs(l,{sx:{color:"text.secondary",textTransform:"capitalize"},children:[n("detailView.orderDetails.customer"),s==null?void 0:s.name]}),e.jsxs(l,{sx:{color:"text.secondary"},children:[n("detailView.orderDetails.tel"),s==null?void 0:s.phoneNumber]})]})]}),e.jsx(l,{fullWidth:!0,alignItems:"center",sx:{p:2,borderBottom:c=>`dashed 2px ${c.vars.palette.background.neutral}`},children:e.jsx(Ce,{products:t.productToOrder,isDetail:!0})}),g,(t==null?void 0:t.notes)&&e.jsx(r,{justifyContent:"space-between",sx:{p:3,typography:"body2"},children:e.jsxs(l,{flexDirection:"column",sx:{display:"flex",width:"100%",p:1},children:[e.jsx(r,{sx:{typography:"subtitle2",marginBottom:1},children:e.jsx("div",{children:n("detailView.orderDetails.notes")})}),e.jsx(l,{sx:{color:"text.secondary"},children:t==null?void 0:t.notes})]})})]}),e.jsx(pe,{currentOrder:t,open:m.value,onClose:m.onFalse})]})}function Oe({currentOrder:t}){const{t:a}=K("orders"),[s,u]=h.useState(t),[x,y]=h.useState(),n=h.useRef(),p=N(),d=ie(),[f,g]=h.useState([]),m=N(),q=ae();h.useEffect(()=>{u(t)},[t]),h.useEffect(()=>{const i=_(s==null?void 0:s.payments,"paymentDate");g(i)},[s==null?void 0:s.payments]);const{mutate:w}=Q({mutationFn:i=>T.post(C.payments.create,i),onSuccess:async i=>{$.success(a("detailView.orderPaymentDialog.newPaymentCreated"));const{data:P}=i,V=_([...f,P],"paymentDate");g(V)},onSettled:async()=>{await d.invalidateQueries({queryKey:["payments"]});const{id:i}=s;await d.invalidateQueries({queryKey:["order",i]}),p.onFalse()},onError:i=>{console.log(i)}}),{mutate:A}=Q({mutationFn:i=>T.get(C.order.approve+i),onSuccess:async({data:i})=>{i!=null&&i.length?(m.onTrue(),y(i)):($.success(a("detailView.orderDetails.approveOrderButton")),u(i))},onSettled:async()=>{const{id:i}=s;await d.invalidateQueries({queryKey:["orders"]}),await d.invalidateQueries({queryKey:["orders","analytics"]}),await d.invalidateQueries({queryKey:["order",i]})},onError:i=>{console.log(i)}}),{mutate:E}=Q({mutationFn:i=>T.post(C.order.createPlans,i),onSuccess:async({data:i})=>{$.success(a("detailView.orderDetails.approveOrderButton")),u(i),m.onFalse()},onSettled:async()=>{const{id:i}=s;await d.invalidateQueries({queryKey:["orders"]}),await d.invalidateQueries({queryKey:["orders","analytics"]}),await d.invalidateQueries({queryKey:["order",i]})},onError:i=>{console.log(i)}}),B=me.useReactToPrint({content:()=>n.current});return e.jsxs(e.Fragment,{children:[e.jsxs(ne,{children:[e.jsx(je,{links:[{name:a("detailView.breadCrumbsPageRootTitle"),href:k.dashboard.root},{name:a("detailView.breadCrumbsParentPageTitle"),href:k.dashboard.order.root},{name:a("detailView.breadCrumbsPageTitle")}],sx:{mb:{xs:3,md:5}}}),e.jsxs(F,{container:!0,spacing:3,children:[e.jsx(F,{xs:12,md:(s==null?void 0:s.status)!==o.Draft&&(s==null?void 0:s.status)!==o.Canceled?9:12,children:e.jsx(r,{ref:n,spacing:3,direction:{xs:"column-reverse",md:"column"},children:e.jsx(ve,{order:s,customer:s==null?void 0:s.customer,discount:s==null?void 0:s.discount,totalAmount:s==null?void 0:s.totalOrderAmount,handleApproveOrder:A,handlePrint:B})})}),(s==null?void 0:s.status)!==o.Draft&&(s==null?void 0:s.status)!==o.Canceled&&e.jsx(F,{xs:12,md:3,children:e.jsx(Ve,{order:s,payments:f,dialog:p})})]}),e.jsx(ue,{order:s,open:p.value,onClose:p.onFalse,handler:w})]}),e.jsx(he,{open:m.value,onClose:m.onFalse,title:a("detailView.confirmDialog.outOfStockTitle"),content:e.jsxs(e.Fragment,{children:[e.jsx(l,{children:a("detailView.confirmDialog.outOfStockMessage")}),e.jsxs(l,{sx:{mt:1,mb:1},children:[a("detailView.confirmDialog.createPlanPrefix"),e.jsx("span",{style:{fontWeight:"bold"},children:x==null?void 0:x.length}),a("detailView.confirmDialog.createPlanSuffix")]}),x==null?void 0:x.map(i=>e.jsxs(l,{children:[a("detailView.confirmDialog.planDetails.planFor"),e.jsx("span",{style:{fontWeight:"bold"},children:i.product.name})," ",a("detailView.confirmDialog.planDetails.missingQuantity"),e.jsx("span",{style:{fontWeight:"bold",color:`${q.vars.palette.error.light}`},children:i.missingQuantity}),"."]}))]}),action:e.jsx(R,{variant:"contained",color:"error",onClick:()=>{E(x)},children:(x==null?void 0:x.length)>1?a("detailView.confirmDialog.planDetails.createPlansButton"):a("detailView.confirmDialog.planDetails.createPlanButton")})})]})}const Se={title:`Order details | Dashboard - ${re.site.name}`};function It(){const{id:t=""}=de(),a=z({queryKey:["order",t],queryFn:async()=>{const{data:s}=await T.get(C.order.details+t);return s}});return a.isPending||a.isLoading?e.jsx(le,{}):a.isError?e.jsx(ce,{route:k.dashboard.order.root}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{children:e.jsxs("title",{children:[" ",Se.title]})}),e.jsx(Oe,{currentOrder:a.data})]})}export{It as default};

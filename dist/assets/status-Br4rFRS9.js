import{dL as J,r as g,C as N,j as a,S as b,aJ as X,dN as Y,ed as Z,T as ss,bN as ts,dO as ns,dM as es,H as as}from"./index-C2cM-DBs.js";import{u as is,a as w,c as T,p as os,r as rs,g as ds,D as ls,M as cs,S as F,h as us,v as ms,K as ps,T as fs,b as xs,d as D}from"./sortable.esm-BjqmcVNj.js";import{u as ks,m as A}from"./index-BrcFUo_I.js";import{E as gs}from"./empty-content-s5rnlcMr.js";import{u as hs}from"./useMutation-COmH0tpK.js";import{k as ys,K as bs,a as Cs,b as Ss,c as Is,d as js}from"./utils-DWf6VsrA.js";import{F as vs}from"./FormControlLabel-CjAWsVO-.js";import"./utils-km2FGkQ4.js";import"./InputBase-BLNKgjL-.js";import"./formControlState-Dq1zat_P.js";import"./utils-DoM3o7-Q.js";import"./Skeleton-D4bHKsJA.js";import"./image-CAg2ZcR_.js";import"./ListItem-BfmlJSaG.js";import"./AvatarGroup-B-uvJ4Qn.js";const O=!1,P=`${N.site.serverUrl}/api/plans-status`,ws={revalidateIfStale:O,revalidateOnFocus:O,revalidateOnReconnect:O};function Os(){const{data:s,isLoading:l,error:u,isValidating:m}=ks(P,J,ws);return g.useMemo(()=>{const y=(s==null?void 0:s.board.tasks)??{},p=(s==null?void 0:s.board.columns)??[];return{board:{tasks:y,columns:p},boardLoading:l,boardError:u,boardValidating:m,boardEmpty:!l&&!p.length}},[s==null?void 0:s.board.columns,s==null?void 0:s.board.tasks,u,l,m])}async function Ps(s){A(P,l=>{const{board:u}=l;return{...l,board:{...u,columns:s}}},!1)}async function K(s){A(P,l=>{const{board:u}=l;return{...l,board:{...u,tasks:s}}},!1)}const L={"--item-gap":"16px","--item-radius":"12px","--column-gap":"24px","--column-width":"calc(95% /4)","--column-radius":"16px","--column-padding":"20px 16px 16px 16px"};function Es(){const{board:s,boardLoading:l,boardEmpty:u}=Os(),[m,E]=g.useState(!0),y=g.useRef(!1),p=g.useRef(null),[f,C]=g.useState(null),S=s.columns.map(t=>t.id),M=f?S.includes(f):!1,R=is(w(xs,{activationConstraint:{distance:5}}),w(fs,{activationConstraint:{distance:5}}),w(ps,{coordinateGetter:Is})),B=g.useCallback(t=>{var o;if(f&&f in s.tasks)return T({...t,droppableContainers:t.droppableContainers.filter(c=>c.id in s.tasks)});const n=os(t),i=n.length>0?n:rs(t);let e=ds(i,"id");if(e!=null){if(e in s.tasks){const c=s.tasks[e].map(r=>r.id);c.length>0&&(e=(o=T({...t,droppableContainers:t.droppableContainers.filter(r=>r.id!==e&&c.includes(r.id))})[0])==null?void 0:o.id)}return p.current=e,[{id:e}]}return y.current&&(p.current=f),p.current?[{id:p.current}]:[]},[f,s==null?void 0:s.tasks]),I=t=>t in s.tasks?t:Object.keys(s.tasks).find(n=>s.tasks[n].map(i=>i.id).includes(t));g.useEffect(()=>{requestAnimationFrame(()=>{y.current=!1})},[]);const V=({active:t})=>{C(t.id)},q=({active:t,over:n})=>{const i=n==null?void 0:n.id;if(i==null||t.id in s.tasks)return;const e=I(i),o=I(t.id);if(!(!e||!o)&&o!==e){const c=s.tasks[o].map(d=>d.id),r=s.tasks[e].map(d=>d.id),h=r.indexOf(i),x=c.indexOf(t.id);let k;if(i in s.tasks)k=r.length+1;else{const _=n&&t.rect.current.translated&&t.rect.current.translated.top>n.rect.top+n.rect.height?1:0;k=h>=0?h+_:r.length+1}y.current=!0;const j={...s.tasks,[o]:s.tasks[o].filter(d=>d.id!==t.id),[e]:[...s.tasks[e].slice(0,k),s.tasks[o][x],...s.tasks[e].slice(k,s.tasks[e].length)]};K(j)}},H=()=>{s.columns.forEach(t=>{for(let n=0;n<s.tasks[t.id].length;n++)t.name==="Pending"&&(s.tasks[t.id][n].status="Pending"),t.name==="Processing A"&&(s.tasks[t.id][n].status="ProcessingA"),t.name==="Processing B"&&(s.tasks[t.id][n].status="ProcessingB"),t.name==="Ready"&&(s.tasks[t.id][n].status="Ready")})},Q=async t=>{const n=[];s.columns.forEach(e=>{n.push(...s.tasks[e.id])});const i=n.find(e=>e.id===t.id);if(i){const e={status:i.status};await U({id:i.id,payload:e})}},z=({active:t,over:n})=>{let i;if(t.id in s.tasks&&(n!=null&&n.id)){const r=S.indexOf(t.id),h=S.indexOf(n.id),x=D(s.columns,r,h);Ps(x)}const e=I(t.id);if(!e){C(null);return}const o=n==null?void 0:n.id;if(o==null){C(null);return}const c=I(o);if(c){const r=s.tasks[e].map(d=>d.id),h=s.tasks[c].map(d=>d.id),x=r.indexOf(t.id),k=h.indexOf(o),j=s.tasks[e][x];if(x!==k){const d={...s.tasks,[c]:D(s.tasks[c],x,k)};K(d)}i={id:j.id,payload:{status:j.status}}}H(),Q(i),C(null)},G=a.jsx(b,{direction:"row",alignItems:"flex-start",sx:{gap:"var(--column-gap)"},children:a.jsx(js,{})}),W=a.jsx(gs,{filled:!0,sx:{py:10,maxHeight:{md:480}}}),$=a.jsxs(ls,{id:"dnd-kanban",sensors:R,collisionDetection:B,measuring:{droppable:{strategy:cs.Always}},onDragStart:V,onDragOver:q,onDragEnd:z,children:[a.jsx(b,{sx:{flex:"1 1 auto",overflowX:"auto"},children:a.jsx(b,{sx:{pb:3,display:"unset",...m&&{minHeight:0,display:"flex",flex:"1 1 auto"}},children:a.jsx(b,{direction:"row",sx:{gap:"var(--column-gap)",...m&&{minHeight:0,flex:"1 1 auto",[`& .${ys.columnList}`]:{...X,flex:"1 1 auto"}}},children:a.jsx(F,{items:[S],strategy:us,children:s==null?void 0:s.columns.map(t=>a.jsx(bs,{column:t,tasks:s.tasks[t.id],children:a.jsx(F,{items:s.tasks[t.id],strategy:ms,children:s.tasks[t.id].map(n=>a.jsx(Cs,{task:n,columnId:t.id,disabled:M},n.id))})},t.id))})})})}),a.jsx(Ss,{columns:s==null?void 0:s.columns,tasks:s==null?void 0:s.tasks,activeId:f,sx:L})]}),v=Y(),{mutate:U}=hs({mutationFn:({id:t,payload:n})=>ns.patch(es.planStatus.edit+t,n),onSuccess:async()=>{await v.invalidateQueries({queryKey:["plans"]}),await v.invalidateQueries({queryKey:["plans","analytics"]}),await v.invalidateQueries({queryKey:["plans-status"]})},onSettled:async()=>{},onError:t=>{console.log(t)}});return a.jsxs(Z,{maxWidth:!1,sx:{...L,pb:0,pl:{sm:3},pr:{sm:0},flex:"1 1 0",display:"flex",overflow:"hidden",flexDirection:"column"},children:[a.jsxs(b,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{pr:{sm:3},mb:{xs:3,md:5}},children:[a.jsx(ss,{variant:"h4",children:"Plans Status"}),a.jsx(vs,{label:"Column fixed",labelPlacement:"start",control:a.jsx(ts,{checked:m,onChange:t=>{E(t.target.checked)},inputProps:{id:"column-fixed-switch"}})})]}),l?G:a.jsx(a.Fragment,{children:u?W:$})]})}const Ts={title:`Plan Status | Dashboard - ${N.site.name}`};function Ws(){return a.jsxs(a.Fragment,{children:[a.jsx(as,{children:a.jsxs("title",{children:[" ",Ts.title]})}),a.jsx(Es,{})]})}export{Ws as default};

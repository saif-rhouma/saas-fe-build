import{dl as on,r as g,C as B,dp as U,au as V,S as u,s as M,v as K,j as t,I as dn,B as I,aJ as cn,A as ln,T as F,d0 as G,i as un,e4 as N,c_ as mn,dn as xn,dQ as gn,aT as fn,dm as yn,H as hn}from"./index-BEaGYMEI.js";import{u as pn}from"./useMutation-CD7lT4vI.js";import{u as bn,a as Cn,b as R,c as q,p as vn,r as Sn,g as jn,D as In,M as wn,S as W,h as Dn,v as On,K as An,T as Tn,d as $n,e as H}from"./sortable.esm-BDq2XdD4.js";import{k as o,u as _,K as kn,a as En,c as Nn,b as Rn}from"./kanban-drag-overlay-C2VShU86.js";import{u as _n,m as X}from"./index-Dk26fFT-.js";import{E as Ln}from"./empty-content-DxNFQfFL.js";import{i as Fn}from"./image-C-zCjJjA.js";import{L as Bn}from"./ListItem-BFzJ2Xb7.js";import{A as Mn}from"./AvatarGroup-BL49mAPT.js";import{F as Kn}from"./FormControlLabel-BO7gRcil.js";import"./utils-km2FGkQ4.js";import"./Skeleton-CcaOVnEt.js";import"./InputBase-Cx_XAmin.js";import"./formControlState-Dq1zat_P.js";import"./utils-DoM3o7-Q.js";const L=!0,E=`${B.site.serverUrl}/api/plans-status`,Gn={revalidateIfStale:L,revalidateOnFocus:L,revalidateOnReconnect:L};function qn(){const{data:n,isLoading:e,error:d,isValidating:f}=_n(E,on,Gn);return g.useMemo(()=>{const p=(n==null?void 0:n.board.tasks)??{},y=(n==null?void 0:n.board.columns)??[];return{board:{tasks:p,columns:y,colors:{Pending:"info","Processing A":"warning","Processing B":"error",Ready:"success"}},boardLoading:e,boardError:d,boardValidating:f,boardEmpty:!e&&!y.length}},[n==null?void 0:n.board.columns,n==null?void 0:n.board.tasks,d,e,f])}async function Wn(n){X(E,e=>{const{board:d}=e;return{...e,board:{...d,columns:n}}},!1);{const e={updateColumns:n};await U.post(E,e,{params:{endpoint:"move-column"}})}}async function Q(n){X(E,e=>{const{board:d}=e;return{...e,board:{...d,tasks:n}}},!1)}const Hn=V(Bn)(()=>({"@keyframes fadeIn":{"0%":{opacity:0},"100%":{opacity:1}},transform:"translate3d(var(--translate-x, 0), var(--translate-y, 0), 0) scaleX(var(--scale-x, 1)) scaleY(var(--scale-y, 1))",transformOrigin:"0 0",touchAction:"manipulation",[`&.${o.state.fadeIn}`]:{animation:"fadeIn 500ms ease"},[`&.${o.state.dragOverlay}`]:{zIndex:999}})),Qn=V(u)(({theme:n})=>({width:"100%",cursor:"grab",outline:"none",overflow:"hidden",position:"relative",transformOrigin:"50% 50%",touchAction:"manipulation",boxShadow:n.customShadows.z1,borderRadius:"var(--item-radius)",WebkitTapHighlightColor:"transparent",backgroundColor:n.vars.palette.common.white,transition:n.transitions.create(["box-shadow"]),[M.dark]:{backgroundColor:n.vars.palette.grey[900]},[`&.${o.state.disabled}`]:{},[`&.${o.state.sorting}`]:{},[`&.${o.state.dragOverlay}`]:{backdropFilter:"blur(6px)",boxShadow:n.customShadows.z20,backgroundColor:K(n.vars.palette.common.whiteChannel,.48),[M.dark]:{backgroundColor:K(n.vars.palette.grey["900Channel"],.48)}},[`&.${o.state.dragging}`]:{opacity:.2,filter:"grayscale(1)"}})),zn=g.forwardRef(({task:n,stateProps:e,sx:d,...f},v)=>{var b,w,D,O;g.useEffect(()=>{if(e!=null&&e.dragOverlay)return document.body.style.cursor="grabbing",()=>{document.body.style.cursor=""}},[e==null?void 0:e.dragOverlay]);const p=o.itemWrap.concat((e==null?void 0:e.fadeIn)&&` ${o.state.fadeIn}`||(e==null?void 0:e.dragOverlay)&&` ${o.state.dragOverlay}`||""),y=o.item.concat((e==null?void 0:e.dragging)&&` ${o.state.dragging}`||(e==null?void 0:e.disabled)&&` ${o.state.disabled}`||(e==null?void 0:e.sorting)&&` ${o.state.sorting}`||(e==null?void 0:e.dragOverlay)&&` ${o.state.dragOverlay}`||""),c=t.jsx(dn,{icon:n.status==="Delivered"?"solar:double-alt-arrow-up-bold-duotone":"solar:double-alt-arrow-right-bold-duotone",sx:{top:4,right:4,position:"absolute",...n.status==="ProcessingA"&&{color:"warning.main"},...n.status==="Ready"&&{color:"success.main"},...n.status==="Pending"&&{color:"info.main"},...n.status==="ProcessingB"&&{color:"error.main"}}}),C=t.jsxs(u,{direction:"row",alignItems:"center",children:[t.jsx(u,{flexGrow:1,direction:"row",alignItems:"center",sx:{typography:"caption",color:"text.disabled"},children:t.jsx(I,{component:"span",sx:{mr:1},children:"Product:"})}),t.jsx(Mn,{sx:{[`& .${cn.avatar}`]:{width:24,height:24}},children:t.jsx(ln,{alt:(b=n==null?void 0:n.product)==null?void 0:b.name,src:`${B.site.serverFileHost}${(w=n==null?void 0:n.product)==null?void 0:w.image}`},(D=n==null?void 0:n.product)==null?void 0:D.id)})]});return t.jsx(Hn,{ref:v,disablePadding:!0,className:p,sx:{...!!(e!=null&&e.transition)&&{transition:e.transition},...!!(e!=null&&e.transform)&&{"--translate-x":`${Math.round(e.transform.x)}px`,"--translate-y":`${Math.round(e.transform.y)}px`,"--scale-x":`${e.transform.scaleX}`,"--scale-y":`${e.transform.scaleY}`}},children:t.jsx(Qn,{className:y,"data-cypress":"draggable-item",sx:d,tabIndex:0,...e==null?void 0:e.listeners,...f,children:t.jsxs(u,{spacing:1,sx:{px:2,py:2.5,position:"relative"},children:[c,t.jsxs(u,{direction:"row",justifyContent:"space-between",children:[t.jsx(F,{variant:"subtitle2",children:(O=n==null?void 0:n.product)==null?void 0:O.name}),t.jsx(F,{variant:"subtitle2",children:n==null?void 0:n.ref})]}),t.jsxs(u,{direction:"row",justifyContent:"space-between",sx:{typography:"body2"},children:[t.jsx(I,{sx:{color:"text.secondary"},children:"Plan Date:"}),t.jsx(I,{sx:{color:"text.secondary"},children:G(n==null?void 0:n.planDate)})]}),t.jsxs(u,{direction:"row",justifyContent:"space-between",sx:{typography:"body2"},children:[t.jsx(I,{sx:{color:"text.secondary"},children:"Quantity:"}),t.jsx(I,{sx:{color:"text.secondary"},children:n.quantity?n.quantity:"-"})]}),t.jsxs(u,{direction:"row",justifyContent:"space-between",sx:{typography:"body2"},children:[t.jsx(I,{sx:{color:"text.secondary"},children:"Last Updated Date:"}),t.jsx(I,{sx:{color:"text.secondary"},children:G(n==null?void 0:n.updateTime)})]}),C]})})})}),Un=g.memo(zn);function Vn({task:n,disabled:e,columnId:d,sx:f}){const v=un(),{setNodeRef:p,listeners:y,isDragging:c,isSorting:C,transform:b,transition:w}=bn({id:n==null?void 0:n.id}),D=Xn(),O=c&&!D;return t.jsx(Un,{ref:e?void 0:p,task:n,onClick:v.onTrue,stateProps:{transform:b,listeners:y,transition:w,sorting:C,dragging:c,fadeIn:O},sx:{...v.value&&{[`& .${Fn.root}`]:{opacity:.8}},...f}})}function Xn(){const[n,e]=g.useState(!1);return g.useEffect(()=>{const d=setTimeout(()=>e(!0),500);return()=>clearTimeout(d)},[]),n}const z={"--item-gap":"16px","--item-radius":"12px","--column-gap":"24px","--column-width":"calc(95% /4)","--column-radius":"16px","--column-padding":"20px 16px 16px 16px"};function Yn(){const{board:n,boardLoading:e,boardEmpty:d}=qn(),[f,v]=g.useState(!0),p=g.useRef(!1),y=g.useRef(null),[c,C]=g.useState(null),b=n.columns.map(s=>s.id),w=c?b.includes(c):!1,D=Cn(R($n,{activationConstraint:{distance:5}}),R(Tn,{activationConstraint:{distance:5}}),R(An,{coordinateGetter:Nn})),O=g.useCallback(s=>{var l;if(c&&c in n.tasks)return q({...s,droppableContainers:s.droppableContainers.filter(h=>h.id in n.tasks)});const a=vn(s),r=a.length>0?a:Sn(s);let i=jn(r,"id");if(i!=null){if(i in n.tasks){const h=n.tasks[i].map(m=>m.id);h.length>0&&(i=(l=q({...s,droppableContainers:s.droppableContainers.filter(m=>m.id!==i&&h.includes(m.id))})[0])==null?void 0:l.id)}return y.current=i,[{id:i}]}return p.current&&(y.current=c),y.current?[{id:y.current}]:[]},[c,n==null?void 0:n.tasks]),T=s=>s in n.tasks?s:Object.keys(n.tasks).find(a=>n.tasks[a].map(r=>r.id).includes(s));g.useEffect(()=>{requestAnimationFrame(()=>{p.current=!1})},[]);const Y=({active:s})=>{C(s.id)},J=({active:s,over:a})=>{const r=a==null?void 0:a.id;if(r==null||s.id in n.tasks)return;const i=T(r),l=T(s.id);if(!(!i||!l)&&l!==i){const h=n.tasks[l].map(x=>x.id),m=n.tasks[i].map(x=>x.id),A=m.indexOf(r),S=h.indexOf(s.id);let j;if(r in n.tasks)j=m.length+1;else{const rn=a&&s.rect.current.translated&&s.rect.current.translated.top>a.rect.top+a.rect.height?1:0;j=A>=0?A+rn:m.length+1}p.current=!0;const k={...n.tasks,[l]:n.tasks[l].filter(x=>x.id!==s.id),[i]:[...n.tasks[i].slice(0,j),n.tasks[l][S],...n.tasks[i].slice(j,n.tasks[i].length)]};Q(k)}},Z=()=>{n.columns.forEach(s=>{for(let a=0;a<n.tasks[s.id].length;a++)s.name==="Pending"&&(n.tasks[s.id][a].status="Pending"),s.name==="Processing A"&&(n.tasks[s.id][a].status="ProcessingA"),s.name==="Processing B"&&(n.tasks[s.id][a].status="ProcessingB"),s.name==="Ready"&&(n.tasks[s.id][a].status="Ready")})},P=async s=>{const a=[];n.columns.forEach(i=>{a.push(...n.tasks[i.id])});const r=a.find(i=>i.id===s.id);if(r){const i={status:r.status};await an({id:r.id,payload:i})}},nn=({active:s,over:a})=>{let r;if(s.id in n.tasks&&(a!=null&&a.id)){const m=b.indexOf(s.id),A=b.indexOf(a.id),S=H(n.columns,m,A);Wn(S)}const i=T(s.id);if(!i){C(null);return}const l=a==null?void 0:a.id;if(l==null){C(null);return}const h=T(l);if(h){const m=n.tasks[i].map(x=>x.id),A=n.tasks[h].map(x=>x.id),S=m.indexOf(s.id),j=A.indexOf(l),k=n.tasks[i][S];if(S!==j){const x={...n.tasks,[h]:H(n.tasks[h],S,j)};Q(x)}r={id:k.id,payload:{status:k.status}}}Z(),P(r),C(null)},en=t.jsx(u,{direction:"row",alignItems:"flex-start",sx:{gap:"var(--column-gap)"},children:t.jsx(Rn,{})}),sn=t.jsx(Ln,{filled:!0,sx:{py:10,maxHeight:{md:480}}}),tn=t.jsxs(In,{id:"dnd-kanban",sensors:D,collisionDetection:O,measuring:{droppable:{strategy:wn.Always}},onDragStart:_(N.PLAN_STATUS_SCREEN_DRAG_AND_DROP)&&Y,onDragOver:_(N.PLAN_STATUS_SCREEN_DRAG_AND_DROP)&&J,onDragEnd:_(N.PLAN_STATUS_SCREEN_DRAG_AND_DROP)&&nn,children:[t.jsx(u,{sx:{flex:"1 1 auto",overflowX:"auto"},children:t.jsx(u,{sx:{pb:3,display:"unset",...f&&{minHeight:0,display:"flex",flex:"1 1 auto"}},children:t.jsx(u,{direction:"row",sx:{gap:"var(--column-gap)",...f&&{minHeight:0,flex:"1 1 auto",[`& .${o.columnList}`]:{...mn,flex:"1 1 auto"}}},children:t.jsx(W,{items:[b],strategy:Dn,children:n==null?void 0:n.columns.map(s=>t.jsx(kn,{column:s,tasks:n.tasks[s.id],colors:n.colors,children:t.jsx(W,{items:n.tasks[s.id],strategy:On,children:n.tasks[s.id].map(a=>t.jsx(Vn,{task:a,columnId:s.id,disabled:w},a.id))})},s.id))})})})}),t.jsx(En,{columns:n==null?void 0:n.columns,tasks:n==null?void 0:n.tasks,activeId:c,sx:z})]}),$=xn(),{mutate:an}=pn({mutationFn:({id:s,payload:a})=>U.patch(yn.planStatus.edit+s,a),onSuccess:async({data:s})=>{const{id:a}=s;await $.invalidateQueries({queryKey:["plans"]}),await $.invalidateQueries({queryKey:["plans","analytics"]}),await $.invalidateQueries({queryKey:["plans-status"]}),await $.invalidateQueries({queryKey:["plan",a]})},onSettled:async()=>{},onError:s=>{console.log(s)}});return t.jsxs(gn,{maxWidth:!1,sx:{...z,pb:0,pl:{sm:3},pr:{sm:0},flex:"1 1 0",display:"flex",overflow:"hidden",flexDirection:"column"},children:[t.jsxs(u,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{pr:{sm:3},mb:{xs:3,md:5}},children:[t.jsx(F,{variant:"h4",children:"Plans Status"}),t.jsx(Kn,{label:"Column fixed",labelPlacement:"start",control:t.jsx(fn,{checked:f,onChange:s=>{v(s.target.checked)},inputProps:{id:"column-fixed-switch"}})})]}),e?en:t.jsx(t.Fragment,{children:d?sn:tn})]})}const Jn={title:`Plan Status | Dashboard - ${B.site.name}`};function xe(){return t.jsxs(t.Fragment,{children:[t.jsx(hn,{children:t.jsxs("title",{children:[" ",Jn.title]})}),t.jsx(Yn,{})]})}export{xe as default};
